# 文本对齐功能添加说明

## 功能概述

在字体设置区域添加了文本对齐方式选项，用户可以选择左对齐或右对齐。该功能特别适用于需要从右到左书写的语言（如阿拉伯语、希伯来语等）。

## UI 设计改进

### 修改前

字体设置区域为 2 列布局：

- 列 1：主语言字体（STHeiti）
- 列 2：次语言字体（Arial）

### 修改后

字体设置区域改为 3 列布局：

- 列 1：主语言字体（缩小宽度）
- 列 2：次语言字体（缩小宽度）
- 列 3：文本对齐方式（新增）

### 对齐方式选项

- **左对齐** <AlignLeft 图标> - 适用于大多数语言（默认）
- **右对齐** <AlignRight 图标> - 适用于 RTL 语言（阿拉伯语、希伯来语等）

## 代码修改

### 1. 前端修改

#### 1.1 LabelContext.tsx

添加 `textAlign` 字段到 `LabelData` 接口：

```typescript
interface LabelData {
  // ...其他字段
  textAlign: string; // 文本对齐方式：left（左对齐）、right（右对齐）、center（居中）
  // ...其他字段
}

const defaultLabelData: LabelData = {
  // ...其他字段
  textAlign: "left", // 默认左对齐
  // ...其他字段
};
```

#### 1.2 LabelEditor.tsx

**导入图标**：

```typescript
import { AlignLeft, AlignRight } from "lucide-react";
```

**UI 布局修改**：

```tsx
{
  /* 第一行：主语言字体、次语言字体、对齐方式 */
}
<div className="grid grid-cols-3 gap-2">
  {/* 主语言字体 - 缩小宽度 */}
  <div className="flex items-center gap-1 border rounded px-2 py-1...">
    <Type className="h-4 w-4..." />
    <select className="text-xs...">...</select>
  </div>

  {/* 次语言字体 - 缩小宽度 */}
  <div className="flex items-center gap-1 border rounded px-2 py-1...">
    <Languages className="h-4 w-4..." />
    <select className="text-xs...">...</select>
  </div>

  {/* 文本对齐方式 - 新增 */}
  <div className="flex items-center gap-1 border rounded px-2 py-1...">
    <button
      onClick={() => updateLabelData({ textAlign: "left" })}
      className={
        labelData.textAlign === "left" ? "bg-[#30B8D6] text-white" : ""
      }
    >
      <AlignLeft className="h-4 w-4" />
    </button>
    <button
      onClick={() => updateLabelData({ textAlign: "right" })}
      className={
        labelData.textAlign === "right" ? "bg-[#30B8D6] text-white" : ""
      }
    >
      <AlignRight className="h-4 w-4" />
    </button>
  </div>
</div>;
```

**保存时包含 textAlign**：

```typescript
await updateFormattedSummary(
  selectedProject.id,
  selectedLanguage,
  formattedSummaryJson,
  {
    fontFamily: labelData.fontFamily,
    secondaryFontFamily: labelData.secondaryFontFamily,
    textAlign: labelData.textAlign, // 新增
    fontSize: labelData.fontSize,
    spacing: labelData.spacing,
    lineHeight: labelData.lineHeight,
  }
);
```

#### 1.3 projectApi.ts

更新接口类型定义：

```typescript
// CountryTranslationGroup 接口
interface CountryTranslationGroup {
  // ...其他字段
  text_align?: string;
  // ...其他字段
}

// updateFormattedSummary 函数
export const updateFormattedSummary = async (
  projectId: number,
  countryCode: string,
  formattedSummary?: string,
  fontSettings?: {
    fontFamily?: string;
    secondaryFontFamily?: string;
    textAlign?: string; // 新增
    fontSize?: number;
    spacing?: number;
    lineHeight?: number;
  },
  originalSummary?: string
): Promise<{
  country_code: string;
  formatted_summary?: string;
  original_summary?: string;
  font_family?: string;
  secondary_font_family?: string;
  text_align?: string; // 新增
  font_size?: number;
  spacing?: number;
  line_height?: number;
}> => {
  // ...
  if (fontSettings) {
    // ...
    if (fontSettings.textAlign !== undefined)
      requestBody.text_align = fontSettings.textAlign;
    // ...
  }
};
```

### 2. 后端修改

#### 2.1 数据库迁移

创建迁移文件：`BackEnd/src/migrations/20241220000013-add-text-align-to-country-translation-groups.js`

```javascript
"use strict";

module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.addColumn("CountryTranslationGroups", "text_align", {
      type: Sequelize.STRING(10),
      allowNull: true,
      defaultValue: "left",
      comment: "文本对齐方式：left（左对齐）、right（右对齐）、center（居中）",
      after: "secondary_font_family",
    });
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn("CountryTranslationGroups", "text_align");
  },
};
```

**运行迁移**：

```bash
cd BackEnd
npm run db:migrate
```

#### 2.2 Model 更新

在 `BackEnd/src/models/countryTranslationGroup.js` 中添加字段：

```javascript
text_align: {
  type: DataTypes.STRING(10),
  allowNull: true,
  defaultValue: "left",
  comment: "文本对齐方式：left（左对齐）、right（右对齐）、center（居中）",
}
```

#### 2.3 数据库设计说明

更新 `BackEnd/数据库设计说明.md`，添加完整的字体设置字段说明表格和使用说明。

## 数据库结构

### CountryTranslationGroups 表新增字段

| 字段名     | 类型        | 默认值 | 说明                                                          |
| ---------- | ----------- | ------ | ------------------------------------------------------------- |
| text_align | VARCHAR(10) | 'left' | 文本对齐方式：left（左对齐）、right（右对齐）、center（居中） |

### 完整字体设置字段

| 字段名                | 类型         | 默认值    | 说明                                        |
| --------------------- | ------------ | --------- | ------------------------------------------- |
| font_family           | VARCHAR(100) | 'STHeiti' | 主语言字体，用于中文、日文、韩文等 CJK 字符 |
| secondary_font_family | VARCHAR(100) | 'Arial'   | 次语言字体，用于英文、数字等拉丁字符        |
| text_align            | VARCHAR(10)  | 'left'    | 文本对齐方式：left/right/center             |
| font_size             | DECIMAL(4,1) | 10.0      | 字体大小（pt）                              |
| spacing               | DECIMAL(3,1) | 1.0       | 间距                                        |
| line_height           | DECIMAL(3,1) | 1.2       | 行高                                        |

## 使用场景

### 左对齐（默认）

适用于大多数语言：

- 中文
- 英文
- 日文
- 韩文
- 泰语
- 越南语
- 等

### 右对齐

适用于从右到左（RTL）的语言：

- 阿拉伯语
- 希伯来语
- 波斯语
- 乌尔都语
- 等

### 居中对齐

特殊排版需求

## 数据流

1. **用户操作** → 点击对齐按钮
2. **状态更新** → `updateLabelData({ textAlign: 'left'|'right' })`
3. **UI 反馈** → 按钮高亮显示选中状态
4. **保存数据** → 点击保存按钮时，将 `textAlign` 保存到数据库
5. **数据加载** → 切换项目/序号/语言时，从数据库加载 `text_align` 字段

## 测试步骤

1. **测试 UI 布局**

   - 检查 3 列布局是否正常显示
   - 检查每列的宽度是否合适
   - 检查图标是否清晰

2. **测试功能**

   - 点击左对齐按钮，检查按钮是否高亮
   - 点击右对齐按钮，检查按钮是否高亮
   - 保存后刷新页面，检查对齐设置是否保持

3. **测试数据持久化**

   - 设置对齐方式后保存
   - 切换到其他项目再切换回来
   - 检查对齐设置是否正确加载

4. **测试跨国别**
   - 为不同国别设置不同的对齐方式
   - 切换国别时检查对齐方式是否正确

## 相关文件

### 前端

- `FrontEnd/lib/context/LabelContext.tsx` - 添加 textAlign 字段
- `FrontEnd/app/components/LabelEditor.tsx` - UI 布局修改和图标添加
- `FrontEnd/lib/projectApi.ts` - API 接口类型定义更新

### 后端

- `BackEnd/src/migrations/20241220000013-add-text-align-to-country-translation-groups.js` - 数据库迁移文件
- `BackEnd/src/models/countryTranslationGroup.js` - Model 字段定义
- `BackEnd/数据库设计说明.md` - 数据库文档更新

## 未来扩展

### 居中对齐

如需要支持居中对齐，可以添加第三个按钮：

```tsx
<button
  onClick={() => updateLabelData({ textAlign: "center" })}
  className={labelData.textAlign === "center" ? "bg-[#30B8D6] text-white" : ""}
>
  <AlignCenter className="h-4 w-4" />
</button>
```

### PDF 预览支持

需要在 PDFPreview.tsx 中应用 textAlign 设置，将其传递给 PDF 渲染组件。

## 注意事项

1. **默认值**：新记录和旧记录的默认对齐方式都是"left"（左对齐）
2. **数据迁移**：运行迁移后，现有数据库记录会自动添加 text_align 字段，默认值为 'left'
3. **兼容性**：旧版本数据（没有 text_align 字段）会使用默认值 'left'
4. **UI 一致性**：按钮高亮颜色使用主题色 #30B8D6，保持与其他 UI 元素一致
