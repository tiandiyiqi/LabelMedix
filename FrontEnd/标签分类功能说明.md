# 标签分类功能说明

本文档说明在不同标签分类下，导入、初始化、格式化、保存四个按钮的功能差异。

## 标签分类类型

- **阶梯标**：传统的阶梯型标签布局
- **非阶梯标**：包括以下 4 种类型
  - 单页左右 1
  - 单页左右 2
  - 单页上下 1
  - 单页上下 2

---

## 1. 导入按钮功能

### 1.1 阶梯标模式

**功能描述**：导入当前选中国别的翻译内容

**执行流程**：

1. **前置检查**：检查是否选择了项目和国别
2. **获取翻译数据**：从数据库获取当前国别（`selectedLanguage`）的翻译详情
3. **数据分类处理**：
   - 按 `item_order` 排序翻译项
   - 根据 `field_type` 将翻译内容分类到 6 个字段：
     - `basic_info` → `basicInfo`
     - `number_field` → `numberField`
     - `drug_name` → `drugName`
     - `number_of_sheets` → `numberOfSheets`
     - `drug_description` → `drugDescription`
     - `company_name` → `companyName`
   - 未分类的内容默认放入 `drugDescription`
4. **字体自动选择**：根据当前语言自动选择字体（`getAutoFontsByLanguage`）
5. **更新界面**：将分类后的内容更新到对应的字段区域
6. **自动初始化**：如果数据库未初始化，自动调用初始化功能

**保存位置**：不直接保存到数据库，仅更新界面显示

---

### 1.2 非阶梯标模式

**功能描述**：导入所有国别（除"all"）的翻译内容并合并

**执行流程**：

1. **前置检查**：检查是否选择了项目（不需要国别）
2. **获取翻译数据**：
   - 获取项目完整信息（包含所有国别翻译组）
   - 过滤掉国别码为"all"的翻译组
   - 按 `sequence_number` 排序
3. **数据合并处理**：
   - 遍历每个国别，获取其翻译详情
   - 按 `original_text` 分组，将相同原文的不同国别翻译合并
   - 按序号顺序连接翻译，使用 `" / "` 作为分隔符
   - 例如：`"中文 / English / 日本語"`
4. **数据分类处理**：
   - 将合并后的翻译按 `field_type` 分类到 6 个字段
   - 使用第一个翻译的 `field_type` 作为分类依据
5. **创建映射表**：
   - 创建 `originalTextMap`（翻译文本 → 原文的映射）
   - 用于后续格式化时的变量规则匹配
6. **字体设置**：使用 `Arial Unicode` 作为主字体（支持多语言混合）
7. **更新界面**：将分类后的内容更新到对应的字段区域

**保存位置**：不直接保存到数据库，仅更新界面显示

**特殊说明**：非阶梯标模式导入后**不会自动初始化**，需要手动点击初始化按钮

---

## 2. 初始化按钮功能

### 2.1 阶梯标模式

**功能描述**：将当前字段内容保存为原始状态到数据库

**执行流程**：

1. **前置检查**：
   - 检查是否选择了项目
   - 检查是否选择了国别（`selectedLanguage`）
2. **数据验证**：检查 6 个字段是否有内容
3. **创建原始状态 JSON**：
   ```json
   {
     "basicInfo": "...",
     "numberField": "...",
     "drugName": "...",
     "numberOfSheets": "...",
     "drugDescription": "...",
     "companyName": "..."
   }
   ```
4. **保存到数据库**：
   - 保存到当前选中的国别码（`selectedLanguage`）
   - 保存 `original_summary` 字段
   - 不更新 `formatted_summary` 和字体设置

**保存位置**：`CountryTranslationGroups` 表中，`country_code = selectedLanguage` 的记录

---

### 2.2 非阶梯标模式

**功能描述**：将当前字段内容保存为原始状态到数据库（特殊国别码"all"）

**执行流程**：

1. **前置检查**：
   - 检查是否选择了项目
   - **不需要检查国别**（非阶梯标模式不依赖国别选择）
2. **数据验证**：检查 6 个字段是否有内容
3. **创建原始状态 JSON**：与阶梯标模式相同
4. **保存到数据库**：
   - 保存到特殊国别码 `"all"`
   - 保存 `original_summary` 字段
   - 不更新 `formatted_summary` 和字体设置
   - 如果 `country_code = "all"` 的记录不存在，会自动创建（`sequence_number = 0`）

**保存位置**：`CountryTranslationGroups` 表中，`country_code = "all"` 的记录

**特殊说明**：

- "all" 记录的 `sequence_number` 固定为 0
- "all" 记录不会被包含在序号和国别下拉列表中
- "all" 记录用于存储所有国别翻译的合并内容

---

## 3. 格式化按钮功能

### 3.1 阶梯标模式

**功能描述**：根据格式化状态（0-4）控制字段的显示方式

**执行流程**：

1. **前置检查**：检查是否已初始化（需要 `original_summary`）
2. **格式化状态说明**：
   - 状态 0：原始状态（未格式化）
   - 状态 1-4：不同的格式化效果（如行数、罗马数字等）
3. **字段格式化**：
   - `basicInfo`：5 状态循环（0-4），控制行数和罗马数字
   - `numberField`：5 状态循环（0-4），控制对齐方式
   - `drugName`：5 状态循环（0-4），控制行数和罗马数字
   - `numberOfSheets`：5 状态循环（0-4），控制行数和罗马数字
   - `drugDescription`：智能组合算法，优化行利用率
   - `companyName`：5 状态循环（0-4），控制行数和罗马数字
4. **保存格式化状态**：更新 `formatStatesRef.current` 和 `formatStates` state

**格式化结果**：

- 包含 6 个字段的格式化后内容
- 包含 `formatStates` 对象（记录每个字段的格式化状态）

---

### 3.2 非阶梯标模式

**功能描述**：根据变量规则添加变量，支持变量着色

**执行流程**：

1. **前置检查**：
   - 检查是否已初始化（从 `country_code = "all"` 加载 `original_summary`）
   - 检查或构建 `originalTextMap`（用于变量规则匹配）
2. **变量规则匹配**：
   - 定义变量规则数组（如 `Protocol No.&&&BBBBBBBBBBBB`）
   - 使用 `&&&` 分隔原文和变量
   - 通过 `originalTextMap` 查找翻译文本对应的原文
   - 匹配规则时，只使用第一个语言的原文（多语言用 `" / "` 分隔）
3. **字段格式化处理**：
   - **`basicInfo`、`drugName`、`numberOfSheets`**：
     - 遍历每一行，匹配变量规则
     - 如果匹配成功，在行尾追加变量
     - 记录变量位置到 `variableMarkers` 数组
   - **`drugName` 特殊规则**：
     - 如果原文包含 `"XXX mg"`，将翻译文本中的所有 `"XXX"` 替换为 `"DDD"`
     - 记录替换位置到 `variableMarkers` 数组
   - **`drugDescription`**：
     - 步骤 1：按语言分类收集内容（按 `" / "` 分隔）
     - 步骤 2：对每个语言组执行智能组合算法（最大化行利用率）
     - 步骤 3：替换 `XX` 或 `XXX` 为罗马数字（每个语言组独立计算，从 `totalVariableCount + 1` 开始）
     - 步骤 4：用分隔线（`"————————————————"`）连接各语言组
     - 分隔线长度：根据页面宽度和"—"字符宽度动态计算
4. **变量标记**：
   - 记录每个变量的位置信息：
     ```typescript
     {
       fieldName: string,      // 字段名
       lineIndex: number,      // 行索引
       startPos: number,       // 变量起始位置
       endPos: number,         // 变量结束位置
       isVariable: boolean     // 是否为变量
     }
     ```
5. **设置格式化状态**：
   ```typescript
   {
     basicInfo: 1,        // 已格式化
     numberField: 0,      // 不格式化
     drugName: 1,         // 已格式化
     numberOfSheets: 1,   // 已格式化
     drugDescription: 1,  // 已格式化
     companyName: 0       // 不格式化
   }
   ```

**格式化结果**：

- 包含 6 个字段的格式化后内容（带变量）
- 包含 `variableMarkers` 数组（变量位置信息）
- 包含 `formatStates` 对象（格式化状态）

**变量颜色**：`rgb(145, 0, 130)`（紫色）

---

## 4. 保存按钮功能

### 4.1 阶梯标模式

**功能描述**：保存格式化状态、标签预览区参数，并触发 PDF 生成

**执行流程**：

1. **前置检查**：
   - 检查是否选择了项目
   - 检查格式化状态是否为空
2. **创建格式化状态 JSON**：
   - 使用 `createFormattedSummary()` 函数
   - 包含 6 个字段的格式化后内容（从 `formattedFieldsRef.current` 获取）
   - 包含 `formatStates` 对象（从 `formatStatesRef.current` 获取）
3. **保存到数据库**：
   - 保存到当前选中的国别码（`selectedLanguage`）
   - 保存 `formatted_summary` 字段
   - 保存字体设置（`fontFamily`、`secondaryFontFamily`、`textAlign`、`fontSize`、`spacing`、`lineHeight`）
4. **保存标签预览区参数**：
   - 保存到 `LabelSettings` 表
   - 使用 `selectedLanguage` 和 `selectedNumber` 作为标识
5. **触发 PDF 生成**：
   - 发送 `generate-and-save-pdf` 事件
   - 传递项目 ID、国别码、序号、合并的文本内容

**保存位置**：

- `CountryTranslationGroups` 表：`country_code = selectedLanguage`
- `LabelSettings` 表：`country_code = selectedLanguage`, `sequence_number = selectedNumber`

---

### 4.2 非阶梯标模式

**功能描述**：保存字段内容、变量标记和格式化状态（不保存标签预览区参数，不触发 PDF 生成）

**执行流程**：

1. **前置检查**：
   - 检查是否选择了项目
   - 检查格式化状态是否为空
2. **创建格式化状态 JSON**：
   - 直接使用 `labelData` 中的字段内容
   - 包含 6 个字段的当前内容
   - 包含 `variableMarkers` 数组（变量位置信息）
   - 包含 `formatStates` 对象（从 `formatStatesRef.current` 获取）
3. **保存到数据库**：
   - 保存到特殊国别码 `"all"`
   - 保存 `formatted_summary` 字段
   - 保存字体设置（`fontFamily`、`secondaryFontFamily`、`textAlign`、`fontSize`、`spacing`、`lineHeight`）
4. **跳过标签预览区参数保存**：非阶梯标模式不保存标签预览区参数
5. **跳过 PDF 生成**：非阶梯标模式不触发 PDF 生成

**保存位置**：

- `CountryTranslationGroups` 表：`country_code = "all"`

**特殊说明**：

- 非阶梯标模式不依赖 `selectedLanguage` 和 `selectedNumber`
- 所有非阶梯标类型共享同一个 `"all"` 记录

---

## 5. 功能对比总结

| 功能         | 阶梯标模式                                    | 非阶梯标模式                                                                |
| ------------ | --------------------------------------------- | --------------------------------------------------------------------------- |
| **导入**     | 导入当前国别的翻译                            | 导入所有国别（除"all"）的翻译并合并                                         |
| **初始化**   | 保存到 `selectedLanguage`                     | 保存到 `"all"`                                                              |
| **格式化**   | 使用格式化状态（0-4）控制显示                 | 根据变量规则添加变量，支持变量着色                                          |
| **保存**     | 保存格式化状态、标签预览区参数、触发 PDF 生成 | 保存字段内容、变量标记、格式化状态（不保存标签预览区参数，不触发 PDF 生成） |
| **依赖国别** | 是（需要 `selectedLanguage`）                 | 否（使用 `"all"`）                                                          |
| **变量支持** | 否                                            | 是（紫色着色）                                                              |
| **字段合并** | 是（药品相关字段合并）                        | 否（所有字段独立）                                                          |

---

## 6. 数据流向

### 6.1 阶梯标模式数据流

```
导入 → 界面显示
  ↓
初始化 → 数据库（country_code = selectedLanguage, original_summary）
  ↓
格式化 → 界面显示（formatStates）
  ↓
保存 → 数据库（country_code = selectedLanguage, formatted_summary）
  ↓
PDF生成 → 文件系统
```

### 6.2 非阶梯标模式数据流

```
导入 → 界面显示（originalTextMap）
  ↓
初始化 → 数据库（country_code = "all", original_summary）
  ↓
格式化 → 界面显示（variableMarkers, formatStates）
  ↓
保存 → 数据库（country_code = "all", formatted_summary）
```

---

## 7. 注意事项

1. **非阶梯标模式的"all"记录**：

   - `sequence_number` 固定为 0
   - 不会出现在序号和国别下拉列表中
   - 用于存储所有国别翻译的合并内容

2. **变量规则匹配**：

   - 只使用第一个语言的原文进行匹配（多语言用 `" / "` 分隔）
   - 匹配时使用 `originalTextMap` 查找翻译文本对应的原文

3. **格式化状态**：

   - 阶梯标模式：使用 0-4 的状态值控制显示
   - 非阶梯标模式：使用 0 或 1 表示是否已格式化

4. **PDF 生成**：
   - 只有阶梯标模式会触发 PDF 生成
   - 非阶梯标模式需要手动处理 PDF 生成（如果将来需要）

---

## 8. 相关文件

- `FrontEnd/app/components/LabelEditor.tsx`：主要功能实现
- `FrontEnd/app/components/PDFPreview.tsx`：PDF 预览和渲染
- `FrontEnd/lib/context/LabelContext.tsx`：全局状态管理
- `BackEnd/src/controllers/projectController.js`：后端 API 实现

---

**文档版本**：v1.0  
**最后更新**：2025-01-XX
