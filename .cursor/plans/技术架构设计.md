# 技术架构设计

**负责人**: Bob  
**协作者**: Emma, David  
**创建时间**: 2025-01-13  
**状态**: 进行中

## 1. 系统架构概述

### 1.1 整体架构

LabelMedix 采用前后端分离的现代化 Web 应用架构，基于微服务设计理念，确保系统的可扩展性、可维护性和高性能。

### 1.2 架构原则

- **前后端分离**: 前端专注用户体验，后端专注业务逻辑
- **模块化设计**: 功能模块独立，便于开发和维护
- **可扩展性**: 支持水平扩展和功能扩展
- **高可用性**: 确保系统稳定运行
- **安全性**: 数据安全和用户隐私保护

## 2. 系统架构图

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Web浏览器  │  │  移动浏览器  │  │  桌面应用   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS/HTTP
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Next.js 14.2.16                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │   React 18  │  │ TypeScript  │  │ Tailwind CSS│     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │  Radix UI   │  │ Context API │  │ PDF处理库   │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ RESTful API
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        后端层                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Express.js + Node.js                     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │  路由层     │  │  中间件层   │  │  控制器层   │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │  服务层     │  │  模型层     │  │  工具层     │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ SQL
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │    MySQL    │  │   Redis     │  │   文件存储  │         │
│  │   (主数据库) │  │   (缓存)    │  │   (静态资源)│         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流图

```
用户操作 → 前端组件 → API请求 → 后端路由 → 业务逻辑 → 数据访问 → 数据库
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
  界面更新 ← 状态更新 ← 响应数据 ← 数据返回 ← 处理结果 ← 数据查询 ← 数据存储
```

## 3. 技术框架选型

### 3.1 前端技术栈

#### 3.1.1 核心框架

- **Next.js 14.2.16**: React 全栈框架
  - 服务端渲染 (SSR)
  - 静态站点生成 (SSG)
  - API 路由支持
  - 自动代码分割

#### 3.1.2 UI 框架

- **React 18**: 用户界面库
  - 函数组件 + Hooks
  - 并发特性
  - 自动批处理

#### 3.1.3 样式系统

- **Tailwind CSS**: 实用优先的 CSS 框架

  - 响应式设计
  - 组件化样式
  - 性能优化

- **Radix UI**: 无样式组件库
  - 可访问性支持
  - 键盘导航
  - 主题定制

#### 3.1.4 类型系统

- **TypeScript**: 静态类型检查
  - 类型安全
  - 开发体验
  - 代码提示

#### 3.1.5 状态管理

- **React Context API**: 状态管理
  - 全局状态
  - 组件通信
  - 性能优化

#### 3.1.6 PDF 处理

- **@react-pdf/renderer**: PDF 生成
- **pdf-lib**: PDF 操作
- **pdfjs-dist**: PDF 解析
- **jspdf**: PDF 生成

### 3.2 后端技术栈

#### 3.2.1 运行环境

- **Node.js**: JavaScript 运行时
  - 事件驱动
  - 非阻塞 I/O
  - 高性能

#### 3.2.2 Web 框架

- **Express.js**: Web 应用框架
  - 中间件支持
  - 路由管理
  - 模板引擎

#### 3.2.3 数据库

- **MySQL**: 关系型数据库

  - ACID 事务
  - 数据完整性
  - 高性能查询

- **Sequelize ORM**: 对象关系映射
  - 模型定义
  - 查询构建器
  - 数据迁移

#### 3.2.4 认证系统

- **JWT**: JSON Web Token

  - 无状态认证
  - 跨域支持
  - 安全性

- **bcryptjs**: 密码加密
  - 哈希加密
  - 盐值处理
  - 安全性

#### 3.2.5 缓存系统

- **Redis**: 内存数据库
  - 高速缓存
  - 会话存储
  - 消息队列

### 3.3 开发工具

#### 3.3.1 代码质量

- **ESLint**: 代码检查
- **Prettier**: 代码格式化
- **Husky**: Git 钩子
- **lint-staged**: 暂存文件检查

#### 3.3.2 构建工具

- **Webpack**: 模块打包
- **Babel**: JavaScript 编译
- **PostCSS**: CSS 处理

#### 3.3.3 测试框架

- **Jest**: 单元测试
- **React Testing Library**: 组件测试
- **Cypress**: 端到端测试

## 4. 服务器环境要求

### 4.1 开发环境

- **操作系统**: macOS/Linux/Windows
- **Node.js**: >= 18.0.0
- **npm**: >= 8.0.0
- **MySQL**: >= 8.0.0
- **Redis**: >= 6.0.0

### 4.2 生产环境

- **服务器**: 云服务器 (AWS/阿里云/腾讯云)
- **CPU**: 4 核心以上
- **内存**: 8GB 以上
- **存储**: 100GB SSD
- **网络**: 100Mbps 带宽

### 4.3 容器化部署

- **Docker**: 容器化
- **Docker Compose**: 多容器编排
- **Nginx**: 反向代理
- **PM2**: 进程管理

## 5. 数据库设计

### 5.1 数据库架构

```
┌─────────────────────────────────────────────────────────────┐
│                        MySQL 数据库                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   用户表    │  │   项目表    │  │   标签表    │         │
│  │   (users)   │  │  (projects) │  │   (labels)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   会话表    │  │   权限表    │  │   日志表    │         │
│  │ (sessions)  │  │(permissions)│  │   (logs)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 数据模型设计

#### 5.2.1 用户表 (users)

```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role ENUM('admin', 'user') DEFAULT 'user',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 5.2.2 项目表 (projects)

```sql
CREATE TABLE projects (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  language_code VARCHAR(10) NOT NULL,
  page_number INT NOT NULL,
  label_width DECIMAL(10,2) NOT NULL,
  label_height DECIMAL(10,2) NOT NULL,
  font_family VARCHAR(50) NOT NULL,
  font_size DECIMAL(5,2) NOT NULL,
  spacing DECIMAL(5,2) NOT NULL,
  line_height DECIMAL(5,2) NOT NULL,
  drug_info TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 5.2.3 标签表 (labels)

```sql
CREATE TABLE labels (
  id INT PRIMARY KEY AUTO_INCREMENT,
  project_id INT NOT NULL,
  language_code VARCHAR(10) NOT NULL,
  content TEXT NOT NULL,
  pdf_path VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

#### 5.2.4 会话表 (sessions)

```sql
CREATE TABLE sessions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  token VARCHAR(255) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 5.2.5 权限表 (permissions)

```sql
CREATE TABLE permissions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  resource VARCHAR(50) NOT NULL,
  action VARCHAR(50) NOT NULL,
  granted BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 5.3 数据关系图

```
users (1) ──── (n) projects
  │                │
  │                │
  │                └─── (n) labels
  │
  │
  ├─── (n) sessions
  │
  └─── (n) permissions
```

## 6. API 设计

### 6.1 RESTful API 规范

- **基础 URL**: `https://api.labelmedix.com/v1`
- **认证方式**: Bearer Token (JWT)
- **数据格式**: JSON
- **HTTP 方法**: GET, POST, PUT, DELETE

### 6.2 API 端点设计

#### 6.2.1 认证相关

```
POST   /auth/login          # 用户登录
POST   /auth/register       # 用户注册
POST   /auth/logout         # 用户登出
POST   /auth/refresh        # 刷新令牌
```

#### 6.2.2 项目管理

```
GET    /projects            # 获取项目列表
POST   /projects            # 创建新项目
GET    /projects/:id        # 获取项目详情
PUT    /projects/:id        # 更新项目
DELETE /projects/:id        # 删除项目
```

#### 6.2.3 标签管理

```
GET    /projects/:id/labels # 获取项目标签
POST   /projects/:id/labels # 创建标签
PUT    /labels/:id          # 更新标签
DELETE /labels/:id          # 删除标签
```

#### 6.2.4 PDF 处理

```
POST   /pdf/generate        # 生成 PDF
GET    /pdf/:id/download    # 下载 PDF
POST   /pdf/batch           # 批量生成 PDF
```

### 6.3 API 响应格式

```json
{
  "success": true,
  "data": {
    // 响应数据
  },
  "message": "操作成功",
  "timestamp": "2025-01-13T10:30:00Z"
}
```

## 7. 安全架构

### 7.1 认证与授权

- **JWT 认证**: 无状态用户认证
- **角色权限**: 基于角色的访问控制 (RBAC)
- **API 密钥**: 第三方集成认证
- **会话管理**: 安全的会话存储

### 7.2 数据安全

- **密码加密**: bcrypt 哈希加密
- **数据传输**: HTTPS 加密传输
- **SQL 注入防护**: 参数化查询
- **XSS 防护**: 输入验证和输出编码

### 7.3 系统安全

- **CORS 配置**: 跨域资源共享控制
- **速率限制**: API 请求频率限制
- **输入验证**: 严格的数据验证
- **错误处理**: 安全的错误信息处理

## 8. 性能优化

### 8.1 前端性能优化

- **代码分割**: 按路由和组件分割
- **懒加载**: 组件和资源懒加载
- **缓存策略**: 浏览器缓存优化
- **图片优化**: WebP 格式和压缩

### 8.2 后端性能优化

- **数据库优化**: 索引和查询优化
- **缓存机制**: Redis 缓存热点数据
- **连接池**: 数据库连接池管理
- **异步处理**: 非阻塞 I/O 操作

### 8.3 系统监控

- **性能监控**: 响应时间和吞吐量
- **错误监控**: 异常和错误追踪
- **资源监控**: CPU、内存、磁盘使用率
- **用户行为**: 用户操作分析

## 9. 部署架构

### 9.1 容器化部署

```yaml
# docker-compose.yml
version: "3.8"
services:
  frontend:
    build: ./FrontEnd
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production

  backend:
    build: ./BackEnd
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - REDIS_HOST=redis

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=labelmedix

  redis:
    image: redis:6.0
    ports:
      - "6379:6379"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
```

### 9.2 负载均衡

- **Nginx**: 反向代理和负载均衡
- **健康检查**: 服务健康状态监控
- **故障转移**: 自动故障恢复
- **SSL 终止**: HTTPS 证书管理

## 10. 技术选型思维链分析

### 10.1 前端框架选型

**问题**: 选择 React 还是 Vue 作为前端框架？
**分析过程**:

1. 团队技术栈熟悉度：团队更熟悉 React
2. 生态系统：React 生态系统更丰富
3. 性能：两者性能相当
4. 学习成本：React 学习曲线更陡峭但更灵活
   **决策**: 选择 React + Next.js，平衡了开发效率和性能

### 10.2 数据库选型

**问题**: 选择关系型数据库还是 NoSQL 数据库？
**分析过程**:

1. 数据结构：标签数据有明确的关系结构
2. 事务需求：需要 ACID 事务保证数据一致性
3. 查询复杂度：需要复杂的关联查询
4. 团队经验：团队更熟悉 SQL
   **决策**: 选择 MySQL，满足数据一致性和复杂查询需求

### 10.3 状态管理选型

**问题**: 选择 Redux 还是 Context API？
**分析过程**:

1. 应用复杂度：应用规模中等，状态管理需求不复杂
2. 学习成本：Context API 更简单易用
3. 性能：Context API 性能足够
4. 维护成本：Context API 代码更少
   **决策**: 选择 Context API，简化状态管理

---

**文档版本**: v1.0  
**最后更新**: 2025-01-13  
**下次评审**: 2025-01-20
