# 序号功能实现说明

## 功能概述

在 PDF 预览页面的"页面边距"下方添加了"序号"设置功能，用户可以控制是否显示序号、序号的对齐位置以及序号的偏移量。

## UI 设计

### 位置

在 PDF 预览区域的参数设置部分，位于"页面边距"的下一行。

### 设置项

1. **是否显示序号**

   - 复选框控制
   - 勾选时显示序号，取消勾选时隐藏序号
   - 默认值：勾选（显示）

2. **序号位置**（3 个对齐选项）

   - **左对齐** - 序号显示在有效区域的左侧
   - **居中对齐** - 序号显示在有效区域的中间
   - **右对齐** - 序号显示在有效区域的右侧
   - 使用图标按钮显示
   - 选中的按钮：蓝色背景 + 白色图标
   - 未选中的按钮：灰色背景 + 70%黑色图标
   - 当"显示序号"未勾选时，这些按钮被禁用
   - 默认值：左对齐

3. **位置偏移**
   - **X（水平位移）**：以毫米为单位，可正可负
   - **Y（垂直位移）**：以毫米为单位，可正可负
   - 输入框，步长 0.5mm
   - 当"显示序号"未勾选时，这些输入框被禁用
   - 默认值：X=0, Y=0

## 数据结构

### FrontEnd/lib/context/LabelContext.tsx

```typescript
interface LabelData {
  // ... 其他字段

  // 序号设置
  showSequenceNumber: boolean; // 是否显示序号
  sequencePosition: string; // 序号位置：left | center | right
  sequenceOffsetX: number; // 序号水平位移（mm）
  sequenceOffsetY: number; // 序号垂直位移（mm）

  // ... 其他字段
}

const defaultLabelData: LabelData = {
  // ... 其他默认值

  showSequenceNumber: true, // 默认显示序号
  sequencePosition: "left", // 默认左对齐
  sequenceOffsetX: 0, // 默认无水平位移
  sequenceOffsetY: 0, // 默认无垂直位移

  // ... 其他默认值
};
```

## 实现细节

### 1. UI 界面实现

**文件**：`FrontEnd/app/components/PDFPreview.tsx`

**位置**：在"页面边距"设置的下方添加新的设置行

**代码结构**：

```tsx
{/* 序号设置 */}
<div className="flex space-x-3">
  <div className="flex-1">
    <div className="flex items-center rounded-md">
      <label>序号：</label>
      <div className="flex items-center gap-4">
        {/* 1. 是否显示序号 */}
        <div className="flex items-center gap-2">
          <input type="checkbox"
            checked={labelData.showSequenceNumber}
            onChange={...}
          />
          <span>显示</span>
        </div>

        {/* 2. 序号位置（左/中/右对齐） */}
        <div className="flex items-center gap-1">
          {/* 左对齐按钮 */}
          <button disabled={!labelData.showSequenceNumber}>
            <svg>...</svg>
          </button>

          {/* 居中对齐按钮 */}
          <button disabled={!labelData.showSequenceNumber}>
            <svg>...</svg>
          </button>

          {/* 右对齐按钮 */}
          <button disabled={!labelData.showSequenceNumber}>
            <svg>...</svg>
          </button>
        </div>

        {/* 3. 位置偏移 */}
        <div className="flex items-center gap-2">
          <div>
            <span>X:</span>
            <input type="number"
              value={labelData.sequenceOffsetX}
              disabled={!labelData.showSequenceNumber}
              step="0.5"
            />
            <span>mm</span>
          </div>

          <div>
            <span>Y:</span>
            <input type="number"
              value={labelData.sequenceOffsetY}
              disabled={!labelData.showSequenceNumber}
              step="0.5"
            />
            <span>mm</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
```

### 2. PDF 渲染实现

**文件**：`FrontEnd/app/components/PDFPreview.tsx`

**函数**：`renderSequenceNumber()`

**实现逻辑**：

```typescript
const renderSequenceNumber = () => {
  // 1. 如果不显示序号，返回 null
  if (!labelData.showSequenceNumber) return null;

  // 2. 获取序号文本（使用当前选中的序号）
  const sequenceText = selectedNumber || "1";

  // 3. 计算序号位置
  const left = mmToPt(margins.left);
  const bottom = mmToPt(margins.bottom + labelData.sequenceOffsetY);
  const width = mmToPt(currentWidth - margins.left - margins.right);

  // 4. 根据对齐方式设置文本对齐
  let textAlign: "left" | "center" | "right" = "left";
  if (labelData.sequencePosition === "center") {
    textAlign = "center";
  } else if (labelData.sequencePosition === "right") {
    textAlign = "right";
  }

  // 5. 渲染序号 View
  return (
    <View
      style={{
        position: "absolute",
        bottom: bottom,
        left: left + mmToPt(labelData.sequenceOffsetX),
        width: width,
        flexDirection: "row",
        justifyContent:
          labelData.sequencePosition === "center"
            ? "center"
            : labelData.sequencePosition === "right"
            ? "flex-end"
            : "flex-start",
      }}
    >
      <Text
        style={{
          fontSize: fontSize,
          fontFamily: fontFamily,
          textAlign: textAlign,
        }}
      >
        {sequenceText}
      </Text>
    </View>
  );
};
```

**渲染位置**：

序号渲染在三个地方：

1. **保存到服务器的 PDF**（`generateAndSavePdfToServer`）
2. **导出下载的 PDF**（`handleExportPDF`）
3. **预览显示的 PDF**（`PDFViewer` 组件内）

在每个 `<Page>` 组件中，在主内容 View 之后添加：

```tsx
<Page>
  {/* 边距矩形框 */}
  <View style={marginBoxStyle} />

  {/* 主内容区域 */}
  <View style={contentAreaStyle}>{renderSixFields()}</View>

  {/* 渲染序号 */}
  {renderSequenceNumber()}
</Page>
```

## 位置计算说明

### 基准位置

- **水平位置**：从页面左边距 (`margins.left`) 开始
- **垂直位置**：从页面底边距 (`margins.bottom`) 开始

### 偏移量应用

- **X 偏移**：在基准水平位置上加上 `sequenceOffsetX`
  - 正值：向右移动
  - 负值：向左移动
- **Y 偏移**：在基准垂直位置上加上 `sequenceOffsetY`
  - 正值：向上移动（远离底部）
  - 负值：向下移动（靠近底部）

### 对齐方式

- **左对齐**：`justifyContent: 'flex-start'`，文本从左边开始
- **居中对齐**：`justifyContent: 'center'`，文本在中间
- **右对齐**：`justifyContent: 'flex-end'`，文本从右边开始

## 使用场景

### 场景 1：显示序号在左下角

- 勾选"显示"
- 选择"左对齐"
- X=0, Y=0

### 场景 2：显示序号在底部居中

- 勾选"显示"
- 选择"居中对齐"
- X=0, Y=0

### 场景 3：显示序号在右下角

- 勾选"显示"
- 选择"右对齐"
- X=0, Y=0

### 场景 4：微调序号位置

- 勾选"显示"
- 选择对齐方式
- 调整 X 或 Y 值进行精确定位

### 场景 5：隐藏序号

- 取消勾选"显示"
- PDF 中不显示序号

## 序号内容来源

序号内容来自 `selectedNumber`（当前选中的序号），这个值通常是：

- 用户在项目列表中选择的序号
- 或者在切换国别码时对应的序号

## 样式一致性

序号的字体样式与主内容保持一致：

- **字体大小**：使用 `fontSize`（与主内容相同）
- **字体**：使用 `fontFamily`（与主内容相同）

## 交互说明

1. **显示复选框**

   - 勾选时：启用位置和偏移控件，PDF 中显示序号
   - 取消勾选时：禁用位置和偏移控件，PDF 中隐藏序号

2. **位置按钮**

   - 点击任意位置按钮，序号会立即在 PDF 预览中移动到新位置
   - 选中的按钮显示蓝色，未选中的显示灰色
   - 鼠标悬停显示 tooltip（"左对齐"、"居中对齐"、"右对齐"）

3. **偏移输入框**
   - 支持键盘输入和上下箭头调整
   - 步长为 0.5mm，可以精确调整
   - 输入后立即在 PDF 预览中更新

## 技术要点

### 1. absolute 定位

序号使用 `position: 'absolute'` 定位，这样可以：

- 不影响主内容的布局
- 精确控制序号位置
- 支持与主内容重叠（如果需要）

### 2. 单位转换

所有位置值都需要从毫米转换为点（pt）：

```typescript
const mmToPt = (mm: number) => mm * 2.83465;
```

### 3. 响应式对齐

使用 `justifyContent` 配合 `flexDirection: 'row'` 实现对齐：

- `flex-start`：左对齐
- `center`：居中对齐
- `flex-end`：右对齐

## 注意事项

1. **序号不保存到数据库**

   - 序号设置当前只在前端 Context 中保存
   - 刷新页面后会恢复默认值
   - 如需持久化，需要添加数据库字段和 API 接口

2. **序号内容是动态的**

   - 序号内容取决于当前选中的项目和语言
   - 切换项目或语言时，序号会自动更新

3. **位置偏移的边界**
   - 没有强制限制偏移量的范围
   - 用户可以将序号移出页面边界（但这通常不推荐）

## 未来扩展建议

1. **数据持久化**

   - 添加数据库字段保存序号设置
   - 在 `projectApi.ts` 中添加相关接口
   - 在 `LabelEditor.tsx` 中同步序号设置

2. **序号样式自定义**

   - 支持自定义序号字体大小
   - 支持自定义序号颜色
   - 支持添加序号前缀/后缀

3. **序号格式化**

   - 支持添加括号：(1)、[1]
   - 支持添加序号文字：No. 1、序号 1
   - 支持罗马数字格式：I、II、III

4. **位置预设**
   - 提供常用位置的快捷按钮
   - 保存用户常用的位置配置

---

**实现完成日期**：2024-12-20  
**实现版本**：v1.0  
**状态**：✅ 完成，可以使用
