# 非阶梯标初始化功能说明

## 📋 功能概述

实现了区分"阶梯标"和"非阶梯标"两种模式的初始化功能，解决多国别翻译合并后的数据存储问题。

---

## 🎯 核心差异对比

| 特性           | 阶梯标模式                        | 非阶梯标模式                      |
| -------------- | --------------------------------- | --------------------------------- |
| **数据来源**   | 单个国别的翻译                    | 所有国别翻译合并（用 " / " 连接） |
| **前置检查**   | 需要项目 + 国别                   | 只需要项目                        |
| **存储位置**   | 当前选中的国别码（如 TH, VN, NZ） | 特殊国别码 `"all"`                |
| **数据特征**   | 单语言内容                        | 多语言混合内容                    |
| **自动初始化** | 导入后自动触发                    | 需要手动触发（暂不自动）          |

---

## 🔄 工作流程

### 阶梯标模式流程

```
用户选择项目 + 国别（如 TH）
    ↓
点击"导入"
    ↓
获取 TH 国别的翻译内容
    ↓
分类到6个字段
    ↓
自动检查是否需要初始化
    ↓
如果需要：
    初始化 → 保存到 country_code = "TH"
    ↓
    格式化
    ↓
    保存
```

### 非阶梯标模式流程

```
用户选择项目（无需选择国别）
    ↓
点击"导入"
    ↓
获取所有国别（除 "all"）的翻译内容
    ↓
按 original_text 分组合并
    例如：
    - 原文: "方案编号："
    - TH 翻译: "หมายเลขโครงการ:"
    - VN 翻译: "Số chương trình:"
    - 合并结果: "หมายเลขโครงการ: / Số chương trình:"
    ↓
分类到6个字段
    ↓
用户手动点击"初始化"
    ↓
保存到 country_code = "all"
```

---

## 💾 数据库存储结构

### CountryTranslationGroups 表

```sql
-- 阶梯标模式示例
INSERT INTO CountryTranslationGroups (
    project_id,
    country_code,
    sequence_number,
    original_summary
) VALUES (
    1,
    'TH',  -- 具体国别码
    1,
    '{"basicInfo":"方案编号：\n包装批号：", ...}'
);

-- 非阶梯标模式示例
INSERT INTO CountryTranslationGroups (
    project_id,
    country_code,
    sequence_number,
    original_summary
) VALUES (
    1,
    'all',  -- 特殊国别码，表示所有国别合并
    999,    -- 使用特殊序号（或其他约定值）
    '{"basicInfo":"หมายเลขโครงการ: / Số chương trình: / Program Number:", ...}'
);
```

---

## 🛠️ 代码实现要点

### 1. 前置检查差异化

```typescript
// 判断是否为阶梯标模式
const isLadderMode = labelData.labelCategory === "阶梯标";

// 前置检查：阶梯标需要国别，非阶梯标不需要
if (!selectedProject) {
  showToast("请先选择项目", "info");
  return;
}

if (isLadderMode && !selectedLanguage) {
  showToast("请先选择国别", "info");
  return;
}
```

### 2. 目标国别码动态选择

```typescript
// 根据标签分类决定保存到哪个国别码
const targetCountryCode = isLadderMode ? selectedLanguage : "all";

await updateFormattedSummary(
  selectedProject.id,
  targetCountryCode, // 阶梯标用具体国别，非阶梯标用 "all"
  undefined,
  undefined,
  originalSummaryJson
);
```

### 3. 用户反馈区分

```typescript
if (isLadderMode) {
  showToast("6个字段的原始状态已初始化保存", "success");
} else {
  showToast(`6个字段的原始状态已初始化保存到国别码"all"`, "success");
}
```

---

## 📊 完整数据流示例

### 非阶梯标模式实际场景

假设项目有 3 个国别：TH（序号 1）、VN（序号 2）、EN（序号 3）

**原始翻译数据：**

```json
// TH 国别
{
  "original_text": "方案编号：",
  "translated_text": "หมายเลขโครงการ:",
  "field_type": "basic_info",
  "item_order": 1
}

// VN 国别
{
  "original_text": "方案编号：",
  "translated_text": "Số chương trình:",
  "field_type": "basic_info",
  "item_order": 1
}

// EN 国别
{
  "original_text": "方案编号：",
  "translated_text": "Program Number:",
  "field_type": "basic_info",
  "item_order": 1
}
```

**导入后合并：**

```
basicInfo: "หมายเลขโครงการ: / Số chương trình: / Program Number:\n..."
```

**初始化保存到 "all"：**

```json
// country_code = "all" 的记录
{
  "original_summary": {
    "basicInfo": "หมายเลขโครงการ: / Số chương trình: / Program Number:\n...",
    "numberField": "...",
    "drugName": "...",
    "numberOfSheets": "...",
    "drugDescription": "...",
    "companyName": "..."
  }
}
```

---

## 🎨 用户界面变化

### 阶梯标模式

- 序号下拉框：**启用**，可选择序号
- 国别下拉框：**启用**，可选择国别
- 初始化按钮：**正常工作**

### 非阶梯标模式

- 序号下拉框：**禁用**（灰色）
- 国别下拉框：**禁用**（灰色）
- 初始化按钮：**正常工作**（但不依赖国别选择）

---

## ⚠️ 注意事项

### 1. 国别码 "all" 的特殊性

- 在导入时已经过滤掉了 `country_code = "all"` 的记录
- "all" 专门用于存储非阶梯标模式的合并数据
- 不会与现有国别码冲突

### 2. 序号问题

- 非阶梯标模式保存到 "all" 时，`sequence_number` 字段如何设置？
- **建议方案**：使用特殊值（如 999）或者 0，表示这是合并数据

### 3. 后续功能开发

目前非阶梯标模式只实现了：

- ✅ 导入功能（合并所有国别翻译）
- ✅ 初始化功能（保存到 "all"）
- ⏳ 格式化功能（开发中）
- ⏳ 保存功能（开发中）

---

## 🔍 数据验证方法

### 在数据库中验证

```sql
-- 查看项目的所有国别翻译组
SELECT
    id,
    project_id,
    country_code,
    sequence_number,
    LEFT(original_summary, 100) as summary_preview,
    created_at
FROM CountryTranslationGroups
WHERE project_id = ? -- 替换为实际项目ID
ORDER BY
    CASE WHEN country_code = 'all' THEN 1 ELSE 0 END,
    sequence_number;

-- 查看 "all" 国别码的详细内容
SELECT
    country_code,
    original_summary,
    formatted_summary
FROM CountryTranslationGroups
WHERE project_id = ?
  AND country_code = 'all';
```

---

## 🚀 测试步骤

### 测试非阶梯标初始化

1. **创建项目并上传 PDF**

   - 创建一个新项目
   - 设置标签分类为非"阶梯标"（如"单页左右 1"）
   - 上传 PDF 并解析出多个国别的翻译

2. **导入合并翻译**

   - 点击"导入"按钮
   - 观察是否合并了所有国别（除 "all"）
   - 检查字段内容是否用 " / " 连接

3. **初始化到 "all"**

   - 点击"初始化"按钮
   - 应该提示：`6个字段的原始状态已初始化保存到国别码"all"`
   - 不应该提示需要选择国别

4. **数据库验证**
   - 查询 `CountryTranslationGroups` 表
   - 确认存在 `country_code = 'all'` 的记录
   - 检查 `original_summary` 字段内容是否正确

---

## 📝 后续优化建议

1. **sequence_number 标准化**

   - 为 "all" 国别码定义明确的序号规则
   - 建议使用 0 或 999，并在代码中统一

2. **自动初始化**

   - 考虑在非阶梯标模式导入后也自动初始化
   - 或者在格式化/保存时自动检查并初始化

3. **数据迁移**

   - 如果已有项目需要支持非阶梯标模式
   - 需要提供数据迁移工具

4. **UI 优化**
   - 在非阶梯标模式下，可以隐藏国别选择器
   - 或者显示特殊提示："当前为多国合并模式"

---

## ✅ 实现完成确认清单

- [x] 前置检查区分（项目 vs 项目+国别）
- [x] 目标国别码动态选择（具体国别 vs "all"）
- [x] 用户提示信息区分
- [x] 代码无 Lint 错误
- [ ] 功能测试验证
- [ ] 数据库数据验证
- [ ] 后续格式化功能适配
- [ ] 后续保存功能适配

---

**实现时间**：2025-11-16
**实现者**：玄鉴团队 - Alex（代码魔法师）
