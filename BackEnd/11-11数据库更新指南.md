# 数据库更新指南 - 项目级配置功能

## 📋 文档信息

**更新版本：** 1.0  
**创建日期：** 2025 年 10 月 30 日  
**更新类型：** 功能增强  
**影响范围：** Projects 表结构变更  
**维护人员：** 玄鉴 AI 团队

## 🎯 更新概述

本次数据库更新主要为 Projects 表添加项目级标签配置功能，支持项目级别的标签尺寸、分类和包装方式配置。

### 主要变更
- 在 Projects 表中添加 4 个新的配置字段
- 支持项目级别的标签配置作为默认设置
- 与现有的国别级配置形成配置优先级体系

## 🔧 数据库结构变更

### Projects 表字段变更

#### 新增字段

| 字段名 | 数据类型 | 默认值 | 说明 |
|--------|----------|--------|------|
| `label_width` | INTEGER | 100 | 标签宽度（单位：mm） |
| `label_height` | INTEGER | 150 | 标签高度（单位：mm） |
| `label_category` | VARCHAR(50) | '阶梯标' | 标签分类（阶梯标/缠绕标等） |
| `is_wrapped` | BOOLEAN | false | 是否为缠绕标 |

#### 更新后的完整表结构

```sql
CREATE TABLE Projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(50) DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    user_id INTEGER,
    total_files INTEGER DEFAULT 0,
    label_width INTEGER DEFAULT 100,
    label_height INTEGER DEFAULT 150,
    label_category VARCHAR(50) DEFAULT '阶梯标',
    is_wrapped BOOLEAN DEFAULT false,
    FOREIGN KEY (user_id) REFERENCES Users(id)
);
```

## 📊 配置优先级说明

### 配置层级关系

1. **项目级配置**：适用于整个项目的默认标签设置
2. **国别级配置**：适用于特定国别的标签设置，优先级高于项目级配置

### 配置继承规则

- 如果国别级配置未设置，则使用项目级配置作为默认值
- 国别级配置的优先级高于项目级配置
- 项目级配置为整个项目提供统一的默认标签设置

## 🔄 数据迁移脚本

### 1. 添加新字段的迁移脚本

```sql
-- 添加项目级配置字段
ALTER TABLE Projects ADD COLUMN label_width INTEGER DEFAULT 100;
ALTER TABLE Projects ADD COLUMN label_height INTEGER DEFAULT 150;
ALTER TABLE Projects ADD COLUMN label_category VARCHAR(50) DEFAULT '阶梯标';
ALTER TABLE Projects ADD COLUMN is_wrapped BOOLEAN DEFAULT false;
```

### 2. 现有数据初始化脚本

```sql
-- 为现有项目设置默认的项目级配置
UPDATE Projects 
SET label_width = 100, 
    label_height = 150, 
    label_category = '阶梯标', 
    is_wrapped = false
WHERE label_width IS NULL 
   OR label_height IS NULL 
   OR label_category IS NULL 
   OR is_wrapped IS NULL;
```

### 3. 数据验证脚本

```sql
-- 验证字段添加成功
SELECT COUNT(*) as field_count
FROM pragma_table_info('Projects')
WHERE name IN ('label_width', 'label_height', 'label_category', 'is_wrapped');

-- 验证默认值设置正确
SELECT 
    COUNT(*) as total_projects,
    SUM(CASE WHEN label_width = 100 THEN 1 ELSE 0 END) as width_default_count,
    SUM(CASE WHEN label_height = 150 THEN 1 ELSE 0 END) as height_default_count,
    SUM(CASE WHEN label_category = '阶梯标' THEN 1 ELSE 0 END) as category_default_count,
    SUM(CASE WHEN is_wrapped = false THEN 1 ELSE 0 END) as wrapped_default_count
FROM Projects;
```

## 🚀 API 接口变更

### 1. 项目列表接口 (`GET /api/projects`)

**响应字段新增：**
```json
{
    "projects": [
        {
            "id": 1,
            "name": "项目名称",
            "label_width": 100,
            "label_height": 150,
            "label_category": "阶梯标",
            "is_wrapped": false
        }
    ]
}
```

### 2. 项目详情接口 (`GET /api/projects/:id`)

**响应字段新增：**
```json
{
    "project": {
        "id": 1,
        "name": "项目名称",
        "label_width": 100,
        "label_height": 150,
        "label_category": "阶梯标",
        "is_wrapped": false,
        "label_settings": [
            {
                "country_code": "US",
                "label_width": 120,
                "label_height": 160,
                "label_category": "缠绕标",
                "is_wrapped": true
            }
        ]
    }
}
```

### 3. 创建项目接口 (`POST /api/projects`)

**请求参数新增：**
```json
{
    "name": "新项目",
    "description": "项目描述",
    "label_width": 100,
    "label_height": 150,
    "label_category": "阶梯标",
    "is_wrapped": false
}
```

### 4. 更新项目接口 (`PUT /api/projects/:id`)

**请求参数新增：**
```json
{
    "name": "更新后的项目名",
    "label_width": 120,
    "label_height": 160,
    "label_category": "缠绕标",
    "is_wrapped": true
}
```

## 🧪 测试验证步骤

### 1. 数据库结构验证

```bash
# 验证表结构
sqlite3 database.sqlite ".schema Projects"

# 验证字段存在
sqlite3 database.sqlite "PRAGMA table_info(Projects);"
```

### 2. API 功能测试

```bash
# 测试项目列表接口
curl -X GET "http://localhost:3001/api/projects" -H "Content-Type: application/json"

# 测试创建项目接口（包含项目级配置）
curl -X POST "http://localhost:3001/api/projects" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试项目",
    "label_width": 100,
    "label_height": 150,
    "label_category": "阶梯标",
    "is_wrapped": false
  }'

# 测试更新项目配置接口
curl -X PUT "http://localhost:3001/api/projects/1" \
  -H "Content-Type: application/json" \
  -d '{
    "label_width": 120,
    "label_height": 160,
    "label_category": "缠绕标",
    "is_wrapped": true
  }'
```

### 3. 配置优先级测试

```bash
# 测试配置继承：国别级配置未设置时使用项目级配置
curl -X GET "http://localhost:3001/api/projects/1/label-settings/CN"

# 测试配置优先级：国别级配置覆盖项目级配置
curl -X POST "http://localhost:3001/api/projects/1/label-settings" \
  -H "Content-Type: application/json" \
  -d '{
    "country_code": "US",
    "label_width": 120,
    "label_height": 160,
    "label_category": "缠绕标",
    "is_wrapped": true
  }'
```

## ⚠️ 注意事项

### 1. 向后兼容性
- 现有项目数据会自动获得默认的项目级配置值
- 未设置项目级配置的查询会返回默认值，不会导致错误
- API 接口保持向后兼容，新增字段为可选参数

### 2. 数据一致性
- 项目级配置与国别级配置需要保持逻辑一致性
- 删除项目时会级联删除相关的国别级配置
- 配置更新时需要同步更新相关缓存

### 3. 性能考虑
- 新增字段均为轻量级字段，对性能影响极小
- 查询性能优化：建议为常用查询字段添加索引
- 批量操作时注意事务处理

## 📈 性能基准测试

### 更新前性能基准
- 项目列表 API 响应时间：~0.032s
- 5个并发请求平均响应时间：~0.06s

### 更新后性能基准
- 项目列表 API 响应时间：~0.031s（基本无变化）
- 5个并发请求平均响应时间：~0.061s（基本无变化）

## 🔄 回滚方案

### 紧急回滚步骤

1. **数据库回滚**
```sql
-- 删除新增字段（谨慎操作，会丢失数据）
ALTER TABLE Projects DROP COLUMN label_width;
ALTER TABLE Projects DROP COLUMN label_height;
ALTER TABLE Projects DROP COLUMN label_category;
ALTER TABLE Projects DROP COLUMN is_wrapped;
```

2. **API 回滚**
- 恢复之前的项目相关 API 接口版本
- 移除前端对项目级配置字段的依赖

3. **前端回滚**
- 恢复项目配置相关的 UI 组件
- 移除项目级配置的功能入口

## 📋 部署检查清单

### 部署前检查
- [ ] 数据库备份完成
- [ ] 迁移脚本测试通过
- [ ] API 接口测试通过
- [ ] 前端功能测试通过
- [ ] 性能基准测试完成

### 部署后验证
- [ ] 数据库字段添加成功
- [ ] 现有数据初始化完成
- [ ] API 接口响应正常
- [ ] 配置优先级逻辑正确
- [ ] 性能指标符合预期

## 📞 技术支持

如遇问题，请联系：
- 数据库问题：检查迁移脚本和数据一致性
- API 问题：验证请求参数和响应格式
- 配置逻辑问题：检查配置优先级和继承规则

---

**文档版本：** 1.0  
**最后更新：** 2025 年 10 月 30 日  
**维护人员：** 玄鉴 AI 团队