# 新项目显示旧内容问题修复说明

## 问题描述

### 问题 1：点击新项目时显示旧项目内容

**现象**：

- 新建一个项目（没有任何格式化数据）
- 点击这个新项目
- 标签编辑器中的 6 个字段区域仍然显示上一个项目的内容
- **预期行为**：应该清空所有字段，显示空白状态

### 问题 2：PDF 预览区显示"未格式化"

**现象**：

- PDF 预览区域显示文本内容为："未格式化"
- 即使 6 个字段有内容，预览区也不显示

**原因**：

- PDFPreview 组件仍在使用废弃的 `drugInfo` 字段
- `drugInfo` 的默认值被设置为 `'未格式化'`

## 问题根源分析

### 问题 1 的根源

在 `LabelEditor.tsx` 的自动加载内容 `useEffect` 中（第 420-425 行）：

```typescript
} else {
  console.log('⚠️ 未找到格式化或原始数据', {
    project: selectedProject.job_name,
    country: selectedLanguage
  })
}
```

**问题**：当没有找到数据时，只打印日志，但没有清空字段，导致显示的是上一个项目的内容。

### 问题 2 的根源

#### 根源 A：LabelContext.tsx（第 128 行）

```typescript
drugInfo: project?.formattedSummary || "未格式化";
```

当项目没有 `formattedSummary` 时，默认设置为 `'未格式化'`。

#### 根源 B：PDFPreview.tsx（第 489 行）

```typescript
const paragraphs = splitIntoParagraphs(drugInfo);
```

PDFPreview 仍在使用 `drugInfo` 字段，而不是从 6 个独立字段合成内容。

## 解决方案

### 修复 1：自动清空无数据项目的字段

**文件**：`FrontEnd/app/components/LabelEditor.tsx`（第 420-470 行）

**修复内容**：

1. **无数据时清空字段**（第 421-446 行）：

```typescript
} else {
  // 如果既没有格式化数据也没有原始数据，清空所有字段
  updateLabelData({
    basicInfo: '',
    numberField: '',
    drugName: '',
    numberOfSheets: '',
    drugDescription: '',
    companyName: '',
    originalSummary: undefined,
    formatted_summary: undefined
  })

  // 重置格式化状态为0
  setFormatStates({
    basicInfo: 0,
    numberField: 0,
    drugName: 0,
    numberOfSheets: 0,
    drugDescription: 0,
    companyName: 0
  })

  console.log('⚠️ 未找到格式化或原始数据，已清空所有字段', {
    project: selectedProject.job_name,
    country: selectedLanguage
  })
}
```

2. **错误时也清空字段**（第 449-469 行）：

```typescript
} catch (error) {
  console.error('❌ 自动加载内容失败:', error)
  // 出错时也清空字段，避免显示错误的旧数据
  updateLabelData({
    basicInfo: '',
    numberField: '',
    drugName: '',
    numberOfSheets: '',
    drugDescription: '',
    companyName: '',
    originalSummary: undefined,
    formatted_summary: undefined
  })
  setFormatStates({
    basicInfo: 0,
    numberField: 0,
    drugName: 0,
    numberOfSheets: 0,
    drugDescription: 0,
    companyName: 0
  })
}
```

### 修复 2A：移除"未格式化"默认值

**文件**：`FrontEnd/lib/context/LabelContext.tsx`（第 129 行）

**修复前**：

```typescript
drugInfo: project?.formattedSummary || "未格式化";
```

**修复后**：

```typescript
// drugInfo 已废弃，不再使用，改用6个独立字段
drugInfo: project?.formattedSummary || "";
```

### 修复 2B：PDFPreview 使用 6 个字段合成内容

**文件**：`FrontEnd/app/components/PDFPreview.tsx`

#### 步骤 1：添加 6 个字段到解构（第 359 行）

**修复前**：

```typescript
const { labelWidth, labelHeight, drugInfo, selectedLanguage, ... } = labelData
```

**修复后**：

```typescript
const { labelWidth, labelHeight, drugInfo, selectedLanguage, ..., basicInfo, numberField, drugName, numberOfSheets, drugDescription, companyName } = labelData
```

#### 步骤 2：合成内容显示（第 488-502 行）

**修复前**：

```typescript
// 处理文本
const paragraphs = splitIntoParagraphs(drugInfo);
```

**修复后**：

```typescript
// 从6个独立字段合成显示内容
const combinedContent = [
  basicInfo,
  numberField,
  drugName,
  numberOfSheets,
  drugDescription,
  companyName,
]
  .filter((content) => content && content.trim() !== "")
  .join("\n\n\n");

// 处理文本
const paragraphs = splitIntoParagraphs(combinedContent);
```

## 修复效果

### 修复前的问题流程

**场景 A：点击新项目**

1. 用户点击一个新建的项目（无数据）
2. `useEffect` 加载数据 → 未找到数据 → 仅打印日志
3. 6 个字段保持上一个项目的内容 ❌
4. 用户看到错误的旧数据

**场景 B：PDF 预览**

1. PDFPreview 读取 `drugInfo` 字段
2. `drugInfo` 默认值为 `'未格式化'` ❌
3. PDF 预览区显示"未格式化"文本
4. 即使 6 个字段有内容也不显示

### 修复后的正确流程

**场景 A：点击新项目**

1. 用户点击一个新建的项目（无数据）
2. `useEffect` 加载数据 → 未找到数据 → **清空所有字段** ✅
3. 6 个字段显示为空白状态 ✅
4. 用户看到正确的空白状态

**场景 B：PDF 预览**

1. PDFPreview 从 6 个独立字段合成内容 ✅
2. 空字段被过滤掉，非空字段用三个换行符连接
3. PDF 预览区正确显示 6 个字段的内容 ✅
4. 如果所有字段为空，预览区为空白 ✅

## 测试步骤

### 测试 1：新建项目显示空白

1. 打开项目列表，选择一个有内容的项目 A
2. 观察 6 个字段区域显示项目 A 的内容
3. 新建一个项目 B（不导入任何内容）
4. 点击项目 B
5. ✅ 6 个字段应该全部为空白
6. ✅ PDF 预览区应该为空白（不显示"未格式化"）

### 测试 2：切换项目内容正确更新

1. 准备两个项目：
   - 项目 A：有完整的 6 个字段内容
   - 项目 B：新建的空项目
2. 点击项目 A → 显示 A 的内容
3. 点击项目 B → 显示空白 ✅
4. 再次点击项目 A → 显示 A 的内容 ✅
5. PDF 预览区内容随项目切换正确更新 ✅

### 测试 3：导入后立即显示

1. 新建项目 C
2. 点击项目 C → 显示空白 ✅
3. 点击"导入"按钮，导入翻译内容
4. ✅ 6 个字段立即显示导入的内容
5. ✅ PDF 预览区也立即显示内容

### 测试 4：错误处理

1. 模拟网络错误或 API 错误
2. 点击项目时出错
3. ✅ 应该清空所有字段，避免显示错误的旧数据
4. ✅ 控制台显示错误信息

## 技术要点

### 数据流架构改进

**旧架构（废弃）**：

```
drugInfo (单一字段) → PDFPreview显示
```

**新架构（当前）**：

```
6个独立字段 → 合成内容 → PDFPreview显示
basicInfo, numberField, drugName,
numberOfSheets, drugDescription, companyName
```

### 状态管理原则

1. **无数据时的明确状态**：

   - 不保留旧数据
   - 清空所有相关字段
   - 重置所有状态标记

2. **错误时的安全处理**：

   - 清空字段避免显示错误数据
   - 记录错误日志便于调试
   - 保持 UI 状态一致性

3. **数据同步一致性**：
   - 6 个字段是数据源
   - PDF 预览是数据呈现
   - 保持数据流单向性

## 相关文件

- `FrontEnd/app/components/LabelEditor.tsx` - 主编辑器，负责加载和管理 6 个字段
- `FrontEnd/lib/context/LabelContext.tsx` - 全局状态管理
- `FrontEnd/app/components/PDFPreview.tsx` - PDF 预览组件

## 修复日期

2025 年 10 月 19 日

## 注意事项

1. `drugInfo` 字段虽然已废弃但保留在代码中，以防某些旧功能还在使用
2. 未来应该考虑完全移除 `drugInfo` 字段，只使用 6 个独立字段
3. 所有涉及内容显示的组件都应该从 6 个字段读取数据
