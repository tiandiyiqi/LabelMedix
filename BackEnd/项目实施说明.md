# LabelMedix 项目数据库与 API 实施说明

## 实施概览

本次实施完成了 LabelMedix 药品标签翻译系统的完整后端数据库设计、API 开发和前端集成，实现了从 Coze API 解析结果到数据库持久化存储的完整流程。

## ✅ 实施状态：已完成并验证

- **数据库迁移**：✅ 成功（6 个迁移文件全部执行完成）
- **后端服务**：✅ 正常运行（端口 3001）
- **API 接口**：✅ 测试通过
- **前端集成**：✅ 已完成
- **数据库连接**：✅ 已配置（使用 Docker MySQL）

## 已完成的工作

### 1. 数据库设计 ✅

#### 创建的文档

- `BackEnd/数据库设计说明.md` - 完整的数据库设计文档

#### 数据库表结构

1. **Projects (项目表)**

   - 存储项目基本信息
   - 字段：id, job_name, job_description, status, total_files, user_id
   - 状态：draft, processing, completed, failed

2. **CountryTranslationGroups (国别翻译组表)**

   - 存储每个项目下不同国别代码的翻译组
   - 字段：id, project_id, country_code, sequence_number, total_items
   - 约束：每个项目下每个国别代码唯一，序号不重复

3. **TranslationItems (翻译详情表)**
   - 存储具体的翻译条目
   - 字段：id, group_id, field_type, original_text, translated_text, item_order, is_edited
   - 字段类型：basic_info, number_field, drug_description

### 2. 数据库迁移文件 ✅

创建的文件：

- `BackEnd/src/migrations/20240210000004-create-projects.js`
- `BackEnd/src/migrations/20240210000005-create-country-translation-groups.js`
- `BackEnd/src/migrations/20240210000006-create-translation-items.js`

### 3. Sequelize 模型 ✅

创建的文件：

- `BackEnd/src/models/project.js`
- `BackEnd/src/models/countryTranslationGroup.js`
- `BackEnd/src/models/translationItem.js`

模型特性：

- 完整的关联关系定义
- 数据验证规则
- 自定义方法（统计、更新等）
- Hooks（自动标记编辑状态）

### 4. API 路由和控制器 ✅

#### 创建的文件

- `BackEnd/src/controllers/projectController.js`
- `BackEnd/src/routes/projects.js`

#### 实现的 API 端点

**项目管理：**

- `GET /api/projects` - 获取项目列表（分页）
- `GET /api/projects/:id` - 获取项目详情
- `POST /api/projects` - 创建项目
- `PUT /api/projects/:id` - 更新项目
- `DELETE /api/projects/:id` - 删除项目

**翻译管理：**

- `GET /api/projects/:projectId/translations/:countryCode` - 获取特定国别的翻译
- `PUT /api/projects/translations/:itemId` - 更新翻译内容

### 5. 前端集成 ✅

#### 创建的文件

- `FrontEnd/lib/projectApi.ts` - 前端 API 调用模块

#### 更新的文件

- `FrontEnd/.env.local` - 添加后端 API 地址配置
- `FrontEnd/app/components/ProjectList.tsx` - 集成后端 API

#### 实现的功能

- 自动加载项目列表
- 创建项目时保存到数据库
- 删除项目
- 显示项目统计信息（国家数量、翻译数量）
- 显示项目状态

## 数据流程

```
用户上传文件
    ↓
调用 Coze API 解析
    ↓
获取解析结果 (output: { AU: [...], CN: [...], ... })
    ↓
调用后端 API 创建项目
    ↓
后端处理数据并存储到数据库：
  - 创建 Project 记录
  - 为每个国别代码创建 CountryTranslationGroup
  - 为每条翻译创建 TranslationItem
    ↓
返回创建成功的项目
    ↓
前端更新项目列表
```

## 使用方法

### 1. 数据库初始化

```bash
# 在 BackEnd 目录下执行

# 1. 创建数据库（如果还未创建）
npm run db:create

# 2. 运行迁移文件
npm run db:migrate
```

### 2. 启动后端服务

```bash
# 在 BackEnd 目录下执行
npm run dev
```

服务将运行在 `http://localhost:3001`

### 3. 启动前端服务

```bash
# 在 FrontEnd 目录下执行
npm run dev
```

前端将运行在 `http://localhost:3000`

### 4. 测试流程

1. 打开前端页面
2. 点击"新建项目"
3. 上传 PDF 文件
4. 输入工单名称
5. 点击"解析并创建项目"
6. 等待处理完成
7. 在项目列表中查看新创建的项目

## API 使用示例

### 创建项目

```javascript
import { createProject } from "@/lib/projectApi";

const result = await createProject({
  job_name: "NZ-8864-4396-101",
  job_description: "新西兰药品标签翻译",
  coze_result: {
    output: {
      AU: ["Protocol No.:", "BGB-43395 Tablets..."],
      CN: ["方案编号：", "BGB-43395片..."],
      MD: ["Protocol No.:", "BGB-43395 Tablets..."],
      NZ: ["Protocol No.:", "BGB-43395 Tablets..."],
    },
  },
});
```

### 获取项目列表

```javascript
import { getProjects } from "@/lib/projectApi";

const { projects, pagination } = await getProjects(1, 10, "completed");
```

### 更新翻译

```javascript
import { updateTranslation } from "@/lib/projectApi";

await updateTranslation(itemId, {
  translated_text: "修改后的翻译",
  field_type: "drug_description",
});
```

## 重要配置文件

### 后端配置 (BackEnd/.env)

```env
DB_USERNAME=root
DB_PASSWORD=
DB_NAME=labelmedix_dev
DB_HOST=localhost
DB_PORT=3306

PORT=3001
NODE_ENV=development
```

### 前端配置 (FrontEnd/.env.local)

```env
NEXT_PUBLIC_API_BASE_URL=http://localhost:3001
NEXT_PUBLIC_COZE_API_TOKEN=your_token
NEXT_PUBLIC_COZE_WORKFLOW_ID=your_workflow_id
NEXT_PUBLIC_COZE_BASE_URL=https://api.coze.cn
```

## 数据库关系图

```
Users (用户表)
  ↓ (一对多)
Projects (项目表)
  ↓ (一对多)
CountryTranslationGroups (国别翻译组表)
  ↓ (一对多)
TranslationItems (翻译详情表)
```

## 待完成的工作

### 短期优化

1. 实现项目编辑功能（更新 handleSave 函数）
2. 添加项目搜索功能
3. 添加翻译内容编辑界面
4. 添加字段类型标注功能

### 中期扩展

1. 用户认证和权限管理
2. 项目协作功能
3. 翻译版本历史
4. 导出功能（Excel, PDF）

### 长期规划

1. 实时协作编辑
2. 自动翻译建议
3. 翻译记忆库
4. 多语言支持

## 注意事项

1. **数据库连接**：确保 MySQL 服务已启动，并且配置正确
2. **端口占用**：确保 3001 端口（后端）和 3000 端口（前端）未被占用
3. **环境变量**：确保所有环境变量配置正确
4. **CORS**：后端已配置 CORS，允许前端跨域请求
5. **事务处理**：创建项目使用了数据库事务，确保数据一致性

## 故障排查

### 数据库连接失败

- 检查 MySQL 服务是否运行
- 检查 BackEnd/.env 中的数据库配置
- 确认数据库已创建

### API 调用失败

- 检查后端服务是否启动
- 检查 FrontEnd/.env.local 中的 API 地址配置
- 查看浏览器控制台和后端终端的错误信息

### 迁移失败

- 确保数据库已创建
- 检查迁移文件的顺序
- 如需重置：`npm run db:reset`

## 技术栈

**后端：**

- Node.js + Express
- Sequelize ORM
- MySQL
- CORS

**前端：**

- Next.js 14
- TypeScript
- React
- TailwindCSS

**API 集成：**

- Coze API（AI 解析）
- RESTful API（后端接口）

## 验证结果

### 数据库验证 ✅

**已创建的数据库表：**

```sql
mysql> SHOW TABLES;
+----------------------------+
| Tables_in_labelmedix_dev   |
+----------------------------+
| CountryTranslationGroups   |
| Permissions                |
| Projects                   |
| SequelizeMeta              |
| Sessions                   |
| TranslationItems           |
| Users                      |
+----------------------------+
7 rows in set
```

**迁移记录：**

- ✅ 20240210000001-create-users
- ✅ 20240210000002-create-sessions
- ✅ 20240210000003-create-permissions
- ✅ 20240210000004-create-projects
- ✅ 20240210000005-create-country-translation-groups
- ✅ 20240210000006-create-translation-items

### 后端服务验证 ✅

**服务状态：**

```bash
$ curl http://localhost:3001/health
{
  "status": "OK",
  "timestamp": "2025-10-15T02:11:49.991Z"
}
```

**API 测试：**

```bash
$ curl http://localhost:3001/api/projects
{
  "success": true,
  "data": {
    "projects": [],
    "pagination": {
      "total": 0,
      "page": 1,
      "limit": 10,
      "totalPages": 0
    }
  }
}
```

### 配置信息

**数据库配置（BackEnd/.env）：**

```env
DB_USERNAME=root
DB_PASSWORD=root123
DB_NAME=labelmedix_dev
DB_HOST=localhost
DB_PORT=3306
```

**Docker MySQL 容器：**

```bash
容器名称: authmatrix_mysql
镜像: mysql:8.0
状态: Running (Up 40 hours)
端口映射: 0.0.0.0:3306->3306/tcp
```

**后端服务：**

```
端口: 3001
健康检查: http://localhost:3001/health
API 基础路径: http://localhost:3001/api
```

## 已解决的问题

### 1. Permission 模型关联错误 ✅

**问题：** `Permission.belongsToMany called with something that's not a subclass of Sequelize.Model`

**原因：** Permission 模型尝试与不存在的 Role 模型建立关联

**解决方案：** 暂时注释掉 Permission 模型中的 Role 关联，因为当前项目暂不需要复杂的角色权限系统

**文件修改：** `BackEnd/src/models/permission.js`

### 2. 数据库连接失败 ✅

**问题：** `Access denied for user 'root'@'192.168.65.1' (using password: NO)`

**原因：** `.env` 文件中 `DB_PASSWORD` 为空，而 Docker MySQL 容器的 root 密码是 `root123`

**解决方案：** 更新 `.env` 文件，设置正确的数据库密码

**文件修改：** `BackEnd/.env`

### 3. 端口占用问题 ✅

**问题：** `Error: listen EADDRINUSE: address already in use :::3001`

**原因：** 之前启动的后端服务进程仍在运行

**解决方案：** 使用 `lsof -ti:3001 | xargs kill -9` 停止占用端口的进程

---

**实施完成日期：** 2025 年 10 月 15 日
**维护团队：** 玄鉴 AI 团队
**文档版本：** 2.0（已验证）
