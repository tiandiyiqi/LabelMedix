# 序号字体修复说明

## 问题描述

**现象**：序号显示为字母 "a" 而不是圆圈数字 "①"

**原因**：普通的 Arial 字体不支持 Unicode 圆圈数字字符（U+2460-U+2473）

**效果图**：

- ❌ 错误显示：`a`（使用 Arial 字体）
- ✅ 正确显示：`①`（使用 Arial Unicode MS 字体）

---

## 解决方案

### 修改内容

将序号的字体从 `Arial` 改为 `Arial Unicode`（即 Arial Unicode MS）

**修改文件**：`FrontEnd/app/components/PDFPreview.tsx`

**修改位置**：`renderSequenceNumber()` 函数中的 Text 样式

### 修改前

```typescript
<Text
  style={{
    fontSize: 5,
    fontFamily: "Arial", // ❌ 不支持圆圈数字
    textAlign: textAlign,
  }}
>
  {sequenceText}
</Text>
```

### 修改后

```typescript
<Text
  style={{
    fontSize: 5,
    fontFamily: "Arial Unicode", // ✅ 支持圆圈数字
    textAlign: textAlign,
  }}
>
  {sequenceText}
</Text>
```

---

## 字体对比

### Arial（普通 Arial）

- ❌ **不支持** Unicode 圆圈数字
- 显示效果：`a`（显示为乱码或替代字符）
- 原因：字体字符集不包含 U+2460-U+2473 范围

### Arial Unicode MS

- ✅ **完整支持** Unicode 圆圈数字
- 显示效果：`①②③④⑤⑥⑦⑧⑨⑩⑪⑫⑬⑭⑮⑯⑰⑱⑲⑳`
- 原因：包含完整的 Unicode 字符集

---

## 已注册的字体

在 `PDFPreview.tsx` 中已经注册了以下字体：

```typescript
// Arial 字体族
Font.register({
  family: "Arial",
  src: "/fonts/Arial.ttf",
  fonts: [
    { src: "/fonts/Arial.ttf" },
    { src: "/fonts/Arial Bold.ttf", fontWeight: "bold" },
    { src: "/fonts/Arial Italic.ttf", fontStyle: "italic" },
    {
      src: "/fonts/Arial Bold Italic.ttf",
      fontWeight: "bold",
      fontStyle: "italic",
    },
  ],
});

// STHeiti 字体
Font.register({
  family: "STHeiti",
  src: "/fonts/STHeiti.ttf",
});

// Arial Unicode MS（支持 Unicode 字符）
Font.register({
  family: "Arial Unicode",
  src: "/fonts/Arial Unicode.ttf",
});
```

我们使用 `'Arial Unicode'` 就是指向已注册的 Arial Unicode MS 字体。

---

## 圆圈数字支持情况

### Unicode 圆圈数字范围

| 数字 | Unicode | 字符 | 支持字体         |
| ---- | ------- | ---- | ---------------- |
| 1    | U+2460  | ①    | Arial Unicode MS |
| 2    | U+2461  | ②    | Arial Unicode MS |
| 3    | U+2462  | ③    | Arial Unicode MS |
| ...  | ...     | ...  | Arial Unicode MS |
| 20   | U+2473  | ⑳    | Arial Unicode MS |

### 其他字体支持情况

| 字体             | 是否支持圆圈数字 | 显示效果                |
| ---------------- | ---------------- | ----------------------- |
| Arial            | ❌ 否            | 显示为乱码 (a, b, c...) |
| Arial Unicode MS | ✅ 是            | ①②③④⑤...                |
| STHeiti          | ✅ 是（部分）    | ①②③④⑤...                |
| Times New Roman  | ❌ 否            | 显示为方框              |
| Helvetica        | ❌ 否            | 显示为乱码              |

---

## 为什么显示为 "a"

### Unicode 字符码位解释

```typescript
// 我们的代码
String.fromCharCode(0x2460); // 应该是 ①
```

当使用不支持该字符的字体时：

1. PDF 渲染器找不到 Unicode U+2460 的字形
2. 回退到 ASCII 码位的映射
3. 0x2460 % 256 = 0x60 = 96
4. ASCII 96 对应小写字母 'a' 的前一个字符
5. 或者渲染器直接映射到某个替代字符

**简单来说**：字体不支持时，会显示错误的字符。

---

## 测试验证

### 测试步骤

1. **刷新页面**

   - 确保使用最新代码
   - 清除浏览器缓存（Ctrl+Shift+R 或 Cmd+Shift+R）

2. **检查序号显示**

   - 勾选"显示序号"
   - 查看 PDF 预览中的序号

3. **预期结果**

   - ✅ 序号 1 显示为 ①（而不是 a）
   - ✅ 序号 2 显示为 ②
   - ✅ 序号 3 显示为 ③
   - ...
   - ✅ 序号 20 显示为 ⑳

4. **导出测试**
   - 导出 PDF 并打开
   - 验证序号是否正确显示

---

## 备选方案

如果 Arial Unicode MS 仍然有问题，可以尝试以下方案：

### 方案 1：使用 STHeiti 字体

```typescript
fontFamily: 'STHeiti',
```

STHeiti（华文黑体）也支持圆圈数字。

### 方案 2：使用系统默认字体

```typescript
fontFamily: undefined,  // 使用 PDF 默认字体
```

### 方案 3：使用括号格式（不使用 Unicode）

修改 `getCircledNumber` 函数：

```typescript
const getCircledNumber = (num: string) => {
  return `(${num})`; // 所有序号都用括号
};
```

这样所有数字都显示为：(1), (2), (3), ...

### 方案 4：使用其他 Unicode 样式

```typescript
const getCircledNumber = (num: string) => {
  const n = parseInt(num);
  if (n >= 1 && n <= 20) {
    // 使用黑底白字圆圈数字 ⓵-⓴ (U+24F5-U+2503)
    return String.fromCharCode(0x24f4 + n);
  }
  return `(${num})`;
};
```

显示效果：⓵⓶⓷⓸⓹⓺⓻⓼⓽⓾...

---

## 注意事项

1. **字体文件确认**

   - 确保 `/public/fonts/Arial Unicode.ttf` 文件存在
   - 文件大小约 20-30 MB（Arial Unicode MS 是大字体）

2. **性能考虑**

   - Arial Unicode MS 字体较大
   - PDF 生成时间可能稍长
   - 但对于单个序号字符影响很小

3. **跨平台兼容**
   - Arial Unicode MS 在 Windows、macOS、Linux 都可用
   - PDF 中嵌入字体，确保在所有设备上显示一致

---

## 相关文件

- `FrontEnd/app/components/PDFPreview.tsx` - 序号渲染逻辑
- `FrontEnd/序号功能UI优化说明.md` - 功能说明
- `/public/fonts/Arial Unicode.ttf` - 字体文件

---

**修复完成日期**：2024-12-20  
**版本**：v1.2  
**状态**：✅ 已修复，请测试
