# 项目搜索功能说明

## 功能概述

为 LabelMedix 项目管理系统添加了完整的项目搜索功能，支持按工单名称和描述进行模糊搜索。

## 实施日期

2025 年 10 月 15 日

## 功能特性

### 1. 搜索范围

- ✅ **工单名称搜索**：支持工单名称的模糊匹配
- ✅ **工单描述搜索**：支持工单描述的模糊匹配
- ✅ **实时搜索**：输入关键词即时显示搜索结果
- ✅ **大小写不敏感**：搜索时不区分大小写（MySQL 默认）

### 2. 用户界面

#### 搜索输入框

- 位置：项目管理页面顶部
- 占位符文字：`搜索项目（工单名称或描述）...`
- 图标：搜索图标（左侧）
- 样式：圆角、阴影、焦点状态

#### 搜索状态

**加载中状态：**

```
[加载动画图标]
加载中...
```

**空结果状态：**

```
未找到匹配的项目

[清除搜索] 按钮
```

**正常结果：**

- 显示匹配的项目列表
- 每个项目显示：工单名称、统计信息、状态、操作按钮

### 3. 交互逻辑

1. **输入关键词**

   - 用户在搜索框输入关键词
   - `onChange` 事件触发 `handleSearch` 函数
   - 立即调用后端 API 进行搜索

2. **清空搜索**

   - 当搜索结果为空时，显示"清除搜索"按钮
   - 点击按钮清空搜索框并重新加载全部项目

3. **搜索保持**
   - 搜索关键词保存在组件状态中
   - 页面不刷新时搜索状态保持

## 技术实现

### 后端实现

#### 1. 控制器更新（`BackEnd/src/controllers/projectController.js`）

```javascript
// 获取项目列表（分页、搜索、筛选）
exports.getProjects = async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    const offset = (page - 1) * limit;
    const status = req.query.status;
    const search = req.query.search; // 新增搜索参数

    const where = {};
    if (status) {
      where.status = status;
    }

    // 搜索功能：支持工单名称和描述模糊搜索
    if (search) {
      const { Op } = require("sequelize");
      where[Op.or] = [
        { job_name: { [Op.like]: `%${search}%` } },
        { job_description: { [Op.like]: `%${search}%` } },
      ];
    }

    // ... 其余代码
  }
};
```

**关键点：**

- 使用 Sequelize 的 `Op.or` 操作符实现多字段搜索
- 使用 `Op.like` 实现模糊匹配
- `%${search}%` 实现全文模糊搜索

#### 2. Bug 修复

**问题：** TranslationItem.count 缺少 `as` 关键字

```javascript
// 修复前
const translationCount = await TranslationItem.count({
  include: [
    {
      model: CountryTranslationGroup,
      where: { project_id: project.id },
      attributes: [],
    },
  ],
});

// 修复后
const translationCount = await TranslationItem.count({
  include: [
    {
      model: CountryTranslationGroup,
      as: "group", // 添加 as 关键字
      where: { project_id: project.id },
      attributes: [],
    },
  ],
});
```

### 前端实现

#### 1. API 模块更新（`FrontEnd/lib/projectApi.ts`）

```typescript
/**
 * 获取项目列表
 * @param page 页码
 * @param limit 每页数量
 * @param status 项目状态筛选
 * @param search 搜索关键词（工单名称或描述）
 */
export const getProjects = async (
  page: number = 1,
  limit: number = 10,
  status?: 'draft' | 'processing' | 'completed' | 'failed',
  search?: string
): Promise<{
  projects: Project[];
  pagination: {...};
}> => {
  try {
    const params = new URLSearchParams({
      page: page.toString(),
      limit: limit.toString(),
    });

    if (status) {
      params.append('status', status);
    }

    if (search && search.trim()) {
      params.append('search', search.trim());
    }

    // ... 其余代码
  }
};
```

#### 2. 组件更新（`FrontEnd/app/components/ProjectList.tsx`）

**新增状态：**

```typescript
const [searchKeyword, setSearchKeyword] = useState("");
```

**更新加载函数：**

```typescript
// 加载项目列表
const loadProjects = async (search?: string) => {
  try {
    setIsLoading(true);
    const { projects: projectList } = await getProjects(
      1,
      100,
      undefined,
      search
    );
    setProjects(projectList);
  } catch (error) {
    console.error("加载项目列表失败:", error);
  } finally {
    setIsLoading(false);
  }
};

// 处理搜索
const handleSearch = (value: string) => {
  setSearchKeyword(value);
  loadProjects(value);
};
```

**更新搜索框：**

```tsx
<input
  type="text"
  placeholder="搜索项目（工单名称或描述）..."
  value={searchKeyword}
  onChange={(e) => handleSearch(e.target.value)}
  className="w-full pl-10 pr-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 transition-shadow"
  style={{
    borderColor: theme.border,
    backgroundColor: "white",
    color: theme.text,
  }}
/>
```

**添加状态处理：**

```tsx
{
  isLoading ? (
    <div className="text-center py-8">
      <Loader2
        className="h-8 w-8 animate-spin mx-auto"
        style={{ color: theme.primary }}
      />
      <p className="mt-2" style={{ color: theme.subtext }}>
        加载中...
      </p>
    </div>
  ) : projects.length === 0 ? (
    <div className="text-center py-12">
      <p className="text-lg" style={{ color: theme.subtext }}>
        {searchKeyword ? "未找到匹配的项目" : "暂无项目，请创建新项目"}
      </p>
      {searchKeyword && (
        <button
          onClick={() => {
            setSearchKeyword("");
            loadProjects();
          }}
          className="mt-4 px-4 py-2 rounded-lg text-white"
          style={{ backgroundColor: theme.primary }}
        >
          清除搜索
        </button>
      )}
    </div>
  ) : (
    <ul className="space-y-2">{/* 项目列表 */}</ul>
  );
}
```

## API 接口

### 搜索 API

**端点：** `GET /api/projects`

**查询参数：**

| 参数   | 类型   | 必填 | 说明                 |
| ------ | ------ | ---- | -------------------- |
| page   | number | 否   | 页码（默认：1）      |
| limit  | number | 否   | 每页数量（默认：10） |
| status | string | 否   | 项目状态筛选         |
| search | string | 否   | 搜索关键词           |

**示例请求：**

```bash
# 搜索工单名称包含 "001" 的项目
GET /api/projects?search=001

# 搜索并按状态筛选
GET /api/projects?search=NZ&status=completed

# 搜索并分页
GET /api/projects?search=test&page=1&limit=20
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "projects": [
      {
        "id": 1,
        "job_name": "001",
        "job_description": null,
        "status": "processing",
        "total_files": 0,
        "user_id": null,
        "createdAt": "2025-10-15T02:17:13.000Z",
        "updatedAt": "2025-10-15T02:17:13.000Z",
        "creator": null,
        "statistics": {
          "countryCount": 0,
          "translationCount": 0
        }
      }
    ],
    "pagination": {
      "total": 1,
      "page": 1,
      "limit": 10,
      "totalPages": 1
    }
  }
}
```

**空结果响应：**

```json
{
  "success": true,
  "data": {
    "projects": [],
    "pagination": {
      "total": 0,
      "page": 1,
      "limit": 10,
      "totalPages": 0
    }
  }
}
```

## 测试验证

### 后端测试

**1. 测试搜索存在的项目：**

```bash
curl -s "http://localhost:3001/api/projects?search=001" | python3 -m json.tool
```

**预期结果：** 返回包含 "001" 的项目列表 ✅

**2. 测试搜索不存在的项目：**

```bash
curl -s "http://localhost:3001/api/projects?search=notexist" | python3 -m json.tool
```

**预期结果：** 返回空项目列表 ✅

**3. 测试不带搜索参数：**

```bash
curl -s "http://localhost:3001/api/projects" | python3 -m json.tool
```

**预期结果：** 返回所有项目 ✅

### 前端测试

**1. 基本搜索测试：**

- [ ] 打开项目管理页面
- [ ] 在搜索框输入关键词
- [ ] 验证显示匹配的项目

**2. 空结果测试：**

- [ ] 输入不存在的关键词
- [ ] 验证显示"未找到匹配的项目"
- [ ] 验证显示"清除搜索"按钮
- [ ] 点击"清除搜索"按钮
- [ ] 验证显示所有项目

**3. 加载状态测试：**

- [ ] 输入搜索关键词
- [ ] 验证显示加载动画
- [ ] 验证加载完成后显示结果

**4. 实时搜索测试：**

- [ ] 逐个输入字符
- [ ] 验证每次输入都触发搜索
- [ ] 验证结果实时更新

## 性能优化建议

### 短期优化

1. **防抖（Debounce）**

   ```typescript
   // 添加防抖延迟，避免频繁请求
   const debouncedSearch = useMemo(
     () =>
       debounce((value: string) => {
         loadProjects(value);
       }, 300),
     []
   );

   const handleSearch = (value: string) => {
     setSearchKeyword(value);
     debouncedSearch(value);
   };
   ```

2. **缓存搜索结果**

   - 使用 React Query 或 SWR 缓存搜索结果
   - 避免重复请求相同的搜索关键词

3. **分页优化**
   - 当前实现一次加载 100 条记录
   - 可改为真正的分页加载

### 中期优化

1. **全文搜索引擎**

   - 集成 Elasticsearch 或 Meilisearch
   - 提供更快速、更强大的搜索能力

2. **搜索建议**

   - 添加搜索建议下拉列表
   - 显示历史搜索记录

3. **高级搜索**
   - 支持多条件组合搜索
   - 支持日期范围筛选
   - 支持国别代码筛选

## 已知限制

1. **搜索性能**

   - 当项目数量很大时，`LIKE` 查询可能较慢
   - 建议：数据库表添加全文索引

2. **特殊字符**

   - 当前未处理特殊字符转义
   - 建议：添加输入验证和转义

3. **搜索精度**
   - `LIKE %keyword%` 可能返回过多结果
   - 建议：添加相关性排序

## 文件清单

### 修改文件

1. **`BackEnd/src/controllers/projectController.js`**

   - 添加搜索功能支持
   - 修复 TranslationItem.count 错误

2. **`FrontEnd/lib/projectApi.ts`**

   - 更新 `getProjects` 函数签名
   - 添加 search 参数处理

3. **`FrontEnd/app/components/ProjectList.tsx`**
   - 添加 `searchKeyword` 状态
   - 实现 `handleSearch` 函数
   - 更新搜索框绑定
   - 添加加载和空状态处理

### 新增文件

1. **`搜索功能说明.md`** - 本文档

## 总结

✅ **完成的功能：**

- 后端搜索 API 支持
- 前端搜索界面
- 实时搜索
- 加载状态
- 空结果处理
- Bug 修复

🚀 **建议的后续优化：**

- 搜索防抖
- 搜索结果缓存
- 高级搜索选项
- 全文搜索引擎集成

---

**实施日期：** 2025 年 10 月 15 日  
**实施团队：** 玄鉴 AI 团队  
**文档版本：** 1.0

---

# 玄鉴！！！玄鉴！！！玄鉴编程，使命必达！！！！！！！
