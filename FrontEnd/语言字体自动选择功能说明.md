# 语言字体自动选择功能说明

## 问题描述

1. 切换语言时，字体没有立即自动切换（例如从中文切换到韩语时，字体应该从 STHeiti 切换到 Arial Unicode MS）
2. 点击"导入"按钮导入文本后，字体没有根据当前语言自动选择

## 解决方案

### 1. 创建统一的字体选择函数

创建了 `getAutoFontsByLanguage` 函数，根据语言自动选择合适的字体：

```typescript
const getAutoFontsByLanguage = (
  language: string
): { fontFamily: string; secondaryFontFamily: string } => {
  // 检查是否为从右到左的语言
  const isRTL = () => {
    if (!language) return false;
    const rtlKeywords = [
      "Arabic",
      "Hebrew",
      "Persian",
      "Farsi",
      "Urdu",
      "Punjabi",
      "Somali",
    ];
    return rtlKeywords.some((keyword) => language.includes(keyword));
  };

  // 检查是否为需要特殊字体的语言
  const needsUnicodeFont = () => {
    if (!language) return false;
    const unicodeFontLanguages = [
      "Korean",
      "Thai",
      "Vietnamese",
      "Hindi",
      "Bengali",
      "Tamil",
      "Telugu",
      "Gujarati",
      "Kannada",
      "Malayalam",
      "Punjabi",
      "Urdu",
    ];
    return (
      unicodeFontLanguages.some((lang) => language.includes(lang)) ||
      language.includes("KR") ||
      language.includes("TH") ||
      language.includes("VN")
    );
  };

  // 根据语言设置对应的字体
  if (language === "CN" || language.includes("Chinese")) {
    return {
      fontFamily: "STHeiti",
      secondaryFontFamily: "Arial",
    };
  } else if (language === "JP" || language.includes("Japanese")) {
    return {
      fontFamily: "STHeiti",
      secondaryFontFamily: "Arial",
    };
  } else if (isRTL() || needsUnicodeFont()) {
    return {
      fontFamily: "Arial Unicode MS",
      secondaryFontFamily: "Arial Unicode MS",
    };
  } else {
    return {
      fontFamily: "Arial",
      secondaryFontFamily: "Arial",
    };
  }
};
```

### 2. 修改语言切换函数

修改 `handleLanguageChange` 函数，使用统一的字体选择函数：

**修改前**：

- 在函数内部重复定义字体选择逻辑
- 使用局部变量 `newFontFamily` 和 `newSecondaryFontFamily`

**修改后**：

- 调用统一的 `getAutoFontsByLanguage` 函数
- 所有 `updateLabelData` 调用中，都使用 `autoFonts.fontFamily` 和 `autoFonts.secondaryFontFamily`

```typescript
const handleLanguageChange = async (
  e: React.ChangeEvent<HTMLSelectElement>
) => {
  const newLanguage = e.target.value;

  // 使用统一的字体选择函数
  const autoFonts = getAutoFontsByLanguage(newLanguage);

  // ... 其余逻辑使用 autoFonts.fontFamily 和 autoFonts.secondaryFontFamily
};
```

### 3. 修改导入函数

修改 `handleImport` 函数，在导入文本后自动根据当前语言选择字体：

```typescript
const handleImport = async () => {
  // ... 导入逻辑

  // 根据当前语言自动选择字体
  const autoFonts = getAutoFontsByLanguage(selectedLanguage);

  // 更新到对应的字段类型区域，同时更新字体
  updateLabelData({
    basicInfo: fieldTypeGroups.basic_info.join("\n"),
    numberField: fieldTypeGroups.number_field.join("\n"),
    drugName: fieldTypeGroups.drug_name.join("\n"),
    numberOfSheets: fieldTypeGroups.number_of_sheets.join("\n"),
    drugDescription: fieldTypeGroups.drug_description.join("\n"),
    companyName: fieldTypeGroups.company_name.join("\n"),
    fontFamily: autoFonts.fontFamily, // 新增
    secondaryFontFamily: autoFonts.secondaryFontFamily, // 新增
  });

  // ...
};
```

## 字体选择规则

### 中文 (CN / Chinese)

- **主字体**: STHeiti
- **次字体**: Arial

### 日文 (JP / Japanese)

- **主字体**: STHeiti
- **次字体**: Arial

### 韩语 (KR / Korean)

- **主字体**: Arial Unicode MS
- **次字体**: Arial Unicode MS

### 泰语 (TH / Thai)

- **主字体**: Arial Unicode MS
- **次字体**: Arial Unicode MS

### 越南语 (VN / Vietnamese)

- **主字体**: Arial Unicode MS
- **次字体**: Arial Unicode MS

### RTL 语言（阿拉伯语、希伯来语等）

- **主字体**: Arial Unicode MS
- **次字体**: Arial Unicode MS

### 其他语言

- **主字体**: Arial
- **次字体**: Arial

## 触发时机

字体会在以下情况下自动选择：

1. **切换语言时** - `handleLanguageChange` 函数
2. **导入文本时** - `handleImport` 函数
3. **切换序号时** - `handleNumberChange` 函数（从数据库读取，如无则使用自动选择）
4. **点击项目时** - `ProjectList.handleProjectClick` 函数（从数据库读取，如无则使用默认值）

## 调试信息

添加了控制台日志，方便调试：

```
🔍 getAutoFontsByLanguage 被调用，语言: KR South Korea/Korean
  📝 needsUnicodeFont 检查结果: true
  ✅ 匹配到特殊语言，返回 Arial Unicode MS
🔤 导入时自动选择字体: {
  语言: 'KR South Korea/Korean',
  主字体: 'Arial Unicode MS',
  次字体: 'Arial Unicode MS'
}
```

## 测试步骤

1. **测试切换语言**:

   - 选择韩语 (KR South Korea/Korean)
   - 观察字体是否自动切换为 Arial Unicode MS
   - 打开浏览器控制台查看日志

2. **测试导入功能**:

   - 选择韩语语言
   - 点击"导入"按钮
   - 检查字体是否为 Arial Unicode MS
   - 查看控制台日志确认函数被调用

3. **测试其他语言**:
   - 测试中文 (CN) → 应该是 STHeiti
   - 测试泰语 (TH) → 应该是 Arial Unicode MS
   - 测试英语 → 应该是 Arial

## 相关文件

- `FrontEnd/app/components/LabelEditor.tsx` - 主要修改文件
  - 第 1610-1657 行: `getAutoFontsByLanguage` 函数
  - 第 1659-1779 行: `handleLanguageChange` 函数
  - 第 1405-1478 行: `handleImport` 函数

## 注意事项

1. 如果数据库中已经保存了字体设置，会优先使用数据库中的设置
2. 只有在数据库中没有字体设置时，才会使用自动选择的字体
3. 调试日志帮助确认字体选择逻辑是否正确执行
