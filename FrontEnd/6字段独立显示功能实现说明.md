# 6 字段独立显示功能实现说明

## 功能概述

实现了新的 6 个字段独立处理和简单排列显示的功能，同时保留了原有的三段落合成处理方式作为参考。

## 实现内容

### 1. 新增处理函数（已完成）

**位置**：`PDFPreview.tsx` 第 169-221 行

```typescript
// ============================================
// 新的6字段独立处理函数（简单排列方式）
// ============================================

// 处理单个字段的文本内容，返回行数组
const processFieldContent = (fieldContent: string): string[] => {
  if (!fieldContent || fieldContent.trim() === "") {
    return [];
  }

  // 按换行符分割，过滤空行
  return fieldContent
    .split("\n")
    .filter((line) => line.trim() !== "")
    .map((line) => line.trim());
};

// 处理6个字段，返回字段数据结构
interface FieldData {
  fieldName: string;
  lines: string[];
}

const processSixFields = (
  basicInfo: string,
  numberField: string,
  drugName: string,
  numberOfSheets: string,
  drugDescription: string,
  companyName: string
): FieldData[] => {
  const fields: FieldData[] = [];

  // 按顺序处理6个字段
  const fieldContents = [
    { fieldName: "basicInfo", content: basicInfo },
    { fieldName: "numberField", content: numberField },
    { fieldName: "drugName", content: drugName },
    { fieldName: "numberOfSheets", content: numberOfSheets },
    { fieldName: "drugDescription", content: drugDescription },
    { fieldName: "companyName", content: companyName },
  ];

  // 处理每个字段，只保留有内容的字段
  fieldContents.forEach(({ fieldName, content }) => {
    const lines = processFieldContent(content);
    if (lines.length > 0) {
      fields.push({ fieldName, lines });
    }
  });

  return fields;
};
```

### 2. 调用新处理函数（已完成）

**位置**：`PDFPreview.tsx` 第 560-570 行

```typescript
// ============================================
// 新的处理方式：6个字段独立处理，简单排列
// ============================================
const processedFields = processSixFields(
  basicInfo,
  numberField,
  drugName,
  numberOfSheets,
  drugDescription,
  companyName
);
```

### 3. 添加新样式（已完成）

**位置**：`PDFPreview.tsx` 第 582-594 行

```typescript
// 新的简单样式：用于6个字段独立显示
fieldContainer: {
  marginBottom: mmToPt(spacing),
  width: '100%',
},
fieldLine: {
  fontSize: mmToPt(fontSize),
  fontFamily: fontFamily,
  lineHeight: lineHeight,
  textAlign: selectedLanguage === 'AE' ? 'right' : 'left',
  direction: selectedLanguage === 'AE' ? 'rtl' : 'ltr',
  marginBottom: mmToPt(spacing * 0.5),
},
```

### 4. 新增渲染函数（已完成）

**位置**：`PDFPreview.tsx` 第 663-680 行

```typescript
// ============================================
// 新的渲染函数：渲染6个字段（简单排列）
// ============================================
const renderSixFields = () => {
  return (
    <>
      {processedFields.map((field, fieldIndex) => (
        <View key={`field-${fieldIndex}`} style={dynamicStyles.fieldContainer}>
          {field.lines.map((line, lineIndex) => (
            <Text key={`line-${lineIndex}`} style={dynamicStyles.fieldLine}>
              {processText(line)}
            </Text>
          ))}
        </View>
      ))}
    </>
  );
};
```

## 需要手动替换的部分

由于 PDF 预览组件中有 3 个地方使用了旧的渲染方式，需要手动替换为新的简单渲染方式。

### 替换位置 1：generateAndSavePdfToServer 函数（第 706-791 行）

**查找代码**：

```typescript
justifyContent: 'center',
}}>
<View style={{ width: '100%' }}>
  {processedFirstParagraph.map((groupLines, groupIndex) => {
```

**替换为**：

```typescript
justifyContent: 'flex-start',
}}>
<View style={{ width: '100%' }}>
  {/* 使用新的简单排列方式渲染6个字段 */}
  {renderSixFields()}
```

然后删除从 `{processedFirstParagraph.map` 开始到对应的 `</View>` 结束的所有旧代码（大约 85 行）。

### 替换位置 2：handleExportPDF 函数（第 833-918 行）

**查找代码**：

```typescript
justifyContent: 'center',
}}>
<View style={{ width: '100%' }}>
  {processedFirstParagraph.map((groupLines, groupIndex) => {
```

**替换为**：

```typescript
justifyContent: 'flex-start',
}}>
<View style={{ width: '100%' }}>
  {/* 使用新的简单排列方式渲染6个字段 */}
  {renderSixFields()}
```

然后删除从 `{processedFirstParagraph.map` 开始到对应的 `</View>` 结束的所有旧代码。

### 替换位置 3：PDFViewer 渲染（第 1156-1241 行）

**查找代码**：

```typescript
justifyContent: 'center',
}}>
  <View style={{ width: '100%' }}>
    {processedFirstParagraph.map((groupLines, groupIndex) => {
```

**替换为**：

```typescript
justifyContent: 'flex-start',
}}>
  <View style={{ width: '100%' }}>
    {/* 使用新的简单排列方式渲染6个字段 */}
    {renderSixFields()}
```

然后删除从 `{processedFirstParagraph.map` 开始到对应的 `</View>` 结束的所有旧代码。

## 旧代码保留

所有旧的处理逻辑已经被注释标记为参考代码：

**位置**：`PDFPreview.tsx` 第 542-558 行

```typescript
// ============================================
// 旧的处理方式：合成为三段落处理（保留作为参考）
// ============================================
const combinedContent = [
  basicInfo,
  numberField,
  drugName,
  numberOfSheets,
  drugDescription,
  companyName,
]
  .filter((content) => content && content.trim() !== "")
  .join("\n\n\n");

// 处理文本（旧方式）
const paragraphs = splitIntoParagraphs(combinedContent);
const processedFirstParagraph =
  paragraphs.length > 0 ? processFirstParagraph(paragraphs[0]) : [];
const processedSecondParagraph =
  paragraphs.length > 1 ? processOtherParagraph(paragraphs[1]) : [];
const processedRemainingParagraphs = paragraphs
  .slice(2)
  .map((para) => processRemainingParagraphs(para));
```

## 功能特点

### 新方式（简单排列）

1. **独立处理**：每个字段独立处理，不合并
2. **简单排列**：按顺序从上到下显示 6 个字段
3. **过滤空字段**：自动过滤没有内容的字段
4. **行级处理**：每个字段内按行处理，过滤空行

### 旧方式（保留参考）

1. **合成处理**：将 6 个字段合成为一个文本
2. **三段落分割**：使用三个换行符分割成段落
3. **复杂处理**：
   - 第一段：添加罗马序号
   - 第二段：添加下划线
   - 第三段及之后：简单排列

## 显示效果对比

### 新方式显示效果

```
[基本信息字段内容]
行1
行2

[编号栏字段内容]
行1

[药品名称字段内容]
行1

[片数字段内容]
行1

[药品说明字段内容]
行1
行2
行3

[公司名称字段内容]
行1
```

### 旧方式显示效果

```
I. 行1   II. 行2   III. 行3
IV. 行4  V. 行5

行1___  行2___  行3___

行1
行2
行3
```

## 修改日期

2025 年 10 月 19 日

## 注意事项

1. 新的处理方式更简单直观，便于维护
2. 旧的处理代码保留作为参考，不要删除相关函数
3. 如果需要恢复旧方式，可以参考保留的代码
4. 三个渲染位置都需要替换才能生效
